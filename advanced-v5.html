<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸŒ± Ù…Ø­Ù„Ù„ Ø§Ù„ØªØ±Ø¨Ø© Ø§Ù„Ø°ÙƒÙŠ - Ø§Ù„Ø¥ØµØ¯Ø§Ø± 5 (Ù…Ø¹ Ø§Ù„Ù…Ù„Ø¡ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ)</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .header-left {
            flex: 1;
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 15px;
        }

        .language-selector {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .language-dropdown {
            padding: 10px 15px;
            border: 2px solid white;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
            transition: all 0.3s;
            min-width: 120px;
        }

        .language-dropdown:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .language-dropdown:focus {
            outline: none;
            background: rgba(255, 255, 255, 0.3);
        }

        .language-dropdown option {
            background: #667eea;
            color: white;
            padding: 10px;
        }

        .lang-btn {
            padding: 6px 12px;
            border: 2px solid white;
            background: transparent;
            color: white;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            font-size: 12px;
            transition: all 0.3s;
        }

        .lang-btn.active {
            background: white;
            color: #667eea;
        }

        .lang-btn:hover {
            background: rgba(255,255,255,0.2);
        }

        .bridge-status {
            text-align: center;
            padding: 8px;
            font-size: 14px;
            font-weight: bold;
        }

        .content {
            padding: 30px;
        }

        .screen {
            display: none;
        }

        .screen.active {
            display: block;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 20px;
        }

        .mode-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        button {
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: #f0f0f0;
            color: #667eea;
            border: 2px solid #667eea;
        }

        .btn-secondary:hover {
            background: #667eea;
            color: white;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #666;
            font-weight: 500;
        }

        input[type="number"],
        input[type="text"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 5px rgba(102, 126, 234, 0.3);
        }

        input[type="number"]::after {
            content: attr(data-unit);
        }

        .input-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .search-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            margin-bottom: 15px;
        }

        .search-results {
            max-height: 300px;
            overflow-y: auto;
            border: 2px solid #f0f0f0;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .result-item {
            padding: 12px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: background 0.3s;
        }

        .result-item:hover {
            background: #f9f9f9;
        }

        .plant-name {
            font-weight: bold;
            margin: 5px 0;
        }

        .plant-temp {
            font-size: 12px;
            color: #999;
        }

        .selected-plant-info {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #667eea;
        }

        .quality-bar {
            width: 100%;
            height: 20px;
            background: #f0f0f0;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }

        .quality-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.5s ease;
        }

        .results-list {
            display: grid;
            gap: 15px;
        }

        .result-box {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .result-box h4 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .plants-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .plant-card {
            text-align: center;
            padding: 10px;
            background: white;
            border-radius: 8px;
            border: 2px solid #f0f0f0;
            cursor: pointer;
            transition: all 0.3s;
        }

        .plant-card:hover {
            border-color: #667eea;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.2);
        }

        .emoji {
            font-size: 30px;
            display: block;
            margin-bottom: 5px;
        }

        .plant-name-small {
            font-size: 12px;
            font-weight: bold;
        }

        .compatibility {
            font-size: 11px;
            color: #667eea;
            margin-top: 3px;
        }

        .auto-fill-indicator {
            display: inline-block;
            background: #4CAF50;
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            margin-left: 10px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .connection-status {
            font-size: 12px;
            margin-top: 5px;
        }

        .connected {
            color: #4CAF50;
        }

        .disconnected {
            color: #f44336;
        }

        .back-button {
            background: #f0f0f0;
            color: #667eea;
            margin-bottom: 20px;
            width: 100%;
        }

        .info-text {
            background: #e3f2fd;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 14px;
            color: #1976d2;
            border-left: 4px solid #1976d2;
        }

        html[dir="rtl"] .input-row {
            direction: rtl;
        }

        html[dir="ltr"] .input-row {
            direction: ltr;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-left">
                <h1 data-i18n="title">ğŸŒ± Ù…Ø­Ù„Ù„ Ø§Ù„ØªØ±Ø¨Ø© Ø§Ù„Ø°ÙƒÙŠ v5</h1>
            </div>
            <div class="language-selector">
                <select id="languageDropdown" class="language-dropdown" onchange="changeLanguage(this.value)">
                    <option value="ar">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
                    <option value="en">English</option>
                    <option value="fr">FranÃ§ais</option>
                    <option value="es">EspaÃ±ol</option>
                    <option value="de">Deutsch</option>
                    <option value="zh">ä¸­æ–‡</option>
                    <option value="ja">æ—¥æœ¬èª</option>
                    <option value="hi">à¤¹à¤¿à¤‚à¤¦à¥€</option>
                    <option value="tr">TÃ¼rkÃ§e</option>
                    <option value="pt">PortuguÃªs</option>
                </select>
            </div>
        </div>
        <div class="bridge-status" id="bridgeStatus">
            <span id="bridgeStatusText" data-i18n="loading">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...</span>
            <div class="connection-status" id="connectionStatus"></div>
        </div>

        <div class="content">
            <!-- Screen 1: Mode Selection -->
            <div id="modeScreen" class="screen active">
                <h2 data-i18n="selectMode">Ø§Ø®ØªØ± Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„ØªØ­Ù„ÙŠÙ„</h2>
                <div class="mode-buttons">
                    <button class="btn-primary" onclick="switchToAutoAnalysis()">
                        <span data-i18n="autoMode">ğŸ¤– ØªØ­Ù„ÙŠÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠ</span>
                        <span class="auto-fill-indicator" data-i18n="autoFill">Ù…Ù„Ø¡ ØªÙ„Ù‚Ø§Ø¦ÙŠ</span>
                    </button>
                    <button class="btn-primary" onclick="switchToManualSearch()">
                        <span data-i18n="manualMode">ğŸ” ØªØ­Ù„ÙŠÙ„ ÙŠØ¯ÙˆÙŠ</span>
                    </button>
                </div>
                <div class="info-text" data-i18n="autoFillInfo">
                    ğŸ’¡ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙŠÙ…Ù„Ø£ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø¬Ù‡Ø§Ø² Ø§Ù„Ø§Ø³ØªØ´Ø¹Ø§Ø± Ù…Ø¨Ø§Ø´Ø±Ø©
                </div>
            </div>

            <!-- Screen 2: Auto Analysis -->
            <div id="autoScreen" class="screen">
                <button class="btn-secondary back-button" onclick="switchToMode()">â† <span data-i18n="back">Ø±Ø¬ÙˆØ¹</span></button>
                <h2 data-i18n="autoAnalysis">Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ</h2>
                <div class="info-text">
                    ğŸ”Œ <span data-i18n="autoFillAuto">Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØªÙ…Ù„Ø£ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ù…Ù† Ø¬Ù‡Ø§Ø² Ø§Ù„Ø§Ø³ØªØ´Ø¹Ø§Ø± ÙƒÙ„ 5 Ø«ÙˆØ§Ù†ÙŠ</span>
                </div>
                <div class="form-group">
                    <label data-i18n="temperature">Ø¯Ø±Ø¬Ø© Ø§Ù„Ø­Ø±Ø§Ø±Ø© (Â°C)</label>
                    <input type="number" id="autoTemp" placeholder="0.0" step="0.1" readonly style="background: #f9f9f9; cursor: not-allowed;">
                </div>
                <div class="input-row">
                    <div class="form-group">
                        <label data-i18n="moisture">Ø§Ù„Ø±Ø·ÙˆØ¨Ø© (%)</label>
                        <input type="number" id="autoMoisture" placeholder="0.0" step="0.1" readonly style="background: #f9f9f9; cursor: not-allowed;">
                    </div>
                    <div class="form-group">
                        <label data-i18n="ph">pH</label>
                        <input type="number" id="autoPh" placeholder="0.0" step="0.1" readonly style="background: #f9f9f9; cursor: not-allowed;">
                    </div>
                </div>
                <div class="input-row">
                    <div class="form-group">
                        <label data-i18n="nitrogen">Ø§Ù„Ù†ÙŠØªØ±ÙˆØ¬ÙŠÙ† (N)</label>
                        <input type="number" id="autoNitrogen" placeholder="0" readonly style="background: #f9f9f9; cursor: not-allowed;">
                    </div>
                    <div class="form-group">
                        <label data-i18n="phosphorus">Ø§Ù„ÙØ³ÙÙˆØ± (P)</label>
                        <input type="number" id="autoPhosphorus" placeholder="0" readonly style="background: #f9f9f9; cursor: not-allowed;">
                    </div>
                </div>
                <div class="form-group">
                    <label data-i18n="potassium">Ø§Ù„Ø¨ÙˆØªØ§Ø³ÙŠÙˆÙ… (K)</label>
                    <input type="number" id="autoPotassium" placeholder="0" readonly style="background: #f9f9f9; cursor: not-allowed;">
                </div>
                <button class="btn-primary" onclick="analyzeAutoData()" style="width: 100%;">
                    <span data-i18n="analyze">ğŸ” ØªØ­Ù„ÙŠÙ„</span>
                </button>
            </div>

            <!-- Screen 3: Manual Search -->
            <div id="manualSearchScreen" class="screen">
                <button class="btn-secondary back-button" onclick="switchToMode()">â† <span data-i18n="back">Ø±Ø¬ÙˆØ¹</span></button>
                <h2 data-i18n="selectPlant">ğŸ” Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù†Ø¨Ø§Øª</h2>
                <input type="text" id="plantSearchInput" class="search-input" placeholder="Ø§Ø¨Ø­Ø«..." oninput="handlePlantSearch(event)">
                <div class="search-results" id="searchResultsContainer">
                    <div class="result-item" style="text-align: center; color: #999;">
                        <span data-i18n="startTyping">Ø§Ø¨Ø¯Ø£ Ø¨Ø§Ù„ÙƒØªØ§Ø¨Ø© Ù„Ù„Ø¨Ø­Ø«...</span>
                    </div>
                </div>
            </div>

            <!-- Screen 4: Manual Analysis -->
            <div id="manualAnalysisScreen" class="screen">
                <button class="btn-secondary back-button" onclick="switchToManualSearch()">â† <span data-i18n="back">Ø±Ø¬ÙˆØ¹</span></button>
                <div id="selectedPlantInfo" class="selected-plant-info"></div>
                <h2 data-i18n="enterData">Ø£Ø¯Ø®Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ±Ø¨Ø©</h2>
                <div class="form-group">
                    <label data-i18n="temperature">Ø¯Ø±Ø¬Ø© Ø§Ù„Ø­Ø±Ø§Ø±Ø© (Â°C)</label>
                    <input type="number" id="manualTemp" placeholder="25" step="0.1">
                </div>
                <div class="input-row">
                    <div class="form-group">
                        <label data-i18n="moisture">Ø§Ù„Ø±Ø·ÙˆØ¨Ø© (%)</label>
                        <input type="number" id="manualMoisture" placeholder="70" step="0.1">
                    </div>
                    <div class="form-group">
                        <label data-i18n="ph">pH</label>
                        <input type="number" id="manualPh" placeholder="6.5" step="0.1">
                    </div>
                </div>
                <div class="input-row">
                    <div class="form-group">
                        <label data-i18n="nitrogen">Ø§Ù„Ù†ÙŠØªØ±ÙˆØ¬ÙŠÙ† (N)</label>
                        <input type="number" id="manualNitrogen" placeholder="50">
                    </div>
                    <div class="form-group">
                        <label data-i18n="phosphorus">Ø§Ù„ÙØ³ÙÙˆØ± (P)</label>
                        <input type="number" id="manualPhosphorus" placeholder="40">
                    </div>
                </div>
                <div class="form-group">
                    <label data-i18n="potassium">Ø§Ù„Ø¨ÙˆØªØ§Ø³ÙŠÙˆÙ… (K)</label>
                    <input type="number" id="manualPotassium" placeholder="30">
                </div>
                <button class="btn-primary" onclick="analyzeManualData()" style="width: 100%;">
                    <span data-i18n="analyze">ğŸ” ØªØ­Ù„ÙŠÙ„</span>
                </button>
            </div>

            <!-- Screen 5: Results -->
            <div id="resultsScreen" class="screen">
                <button class="btn-secondary back-button" onclick="switchToMode()">â† <span data-i18n="back">Ø±Ø¬ÙˆØ¹</span></button>
                <h2 data-i18n="results">Ø§Ù„Ù†ØªØ§Ø¦Ø¬</h2>
                <div id="resultsList" class="results-list"></div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="plants-multilingual.js"></script>
    <script src="plants-advanced.js"></script>
    <script src="ai-advanced.js"></script>

    <script>
        // Current language and selected plant
        let currentLanguage = 'ar';
        let currentSelectedPlant = null;
        let bridgeConnected = false;
        let lastBridgeData = null;  // Store last bridge data for manual mode auto-fill

        // 10-Language translation system
        const translations = {
            ar: {
                title: 'ğŸŒ± Ù…Ø­Ù„Ù„ Ø§Ù„ØªØ±Ø¨Ø© Ø§Ù„Ø°ÙƒÙŠ v5',
                selectMode: 'Ø§Ø®ØªØ± Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„ØªØ­Ù„ÙŠÙ„',
                autoMode: 'ğŸ¤– ØªØ­Ù„ÙŠÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠ',
                autoFill: 'Ù…Ù„Ø¡ ØªÙ„Ù‚Ø§Ø¦ÙŠ',
                manualMode: 'ğŸ” ØªØ­Ù„ÙŠÙ„ ÙŠØ¯ÙˆÙŠ',
                autoAnalysis: 'Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ',
                autoFillInfo: 'ğŸ’¡ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙŠÙ…Ù„Ø£ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø¬Ù‡Ø§Ø² Ø§Ù„Ø§Ø³ØªØ´Ø¹Ø§Ø± Ù…Ø¨Ø§Ø´Ø±Ø©',
                autoFillAuto: 'Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØªÙ…Ù„Ø£ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ù…Ù† Ø¬Ù‡Ø§Ø² Ø§Ù„Ø§Ø³ØªØ´Ø¹Ø§Ø± ÙƒÙ„ 5 Ø«ÙˆØ§Ù†ÙŠ',
                manualAnalysis: 'Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„ÙŠØ¯ÙˆÙŠ',
                selectPlant: 'ğŸ” Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù†Ø¨Ø§Øª',
                enterData: 'Ø£Ø¯Ø®Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ±Ø¨Ø©',
                temperature: 'Ø¯Ø±Ø¬Ø© Ø§Ù„Ø­Ø±Ø§Ø±Ø© (Â°C)',
                moisture: 'Ø§Ù„Ø±Ø·ÙˆØ¨Ø© (%)',
                ph: 'pH',
                nitrogen: 'Ø§Ù„Ù†ÙŠØªØ±ÙˆØ¬ÙŠÙ† (N)',
                phosphorus: 'Ø§Ù„ÙØ³ÙÙˆØ± (P)',
                potassium: 'Ø§Ù„Ø¨ÙˆØªØ§Ø³ÙŠÙˆÙ… (K)',
                analyze: 'ğŸ” ØªØ­Ù„ÙŠÙ„',
                back: 'Ø±Ø¬ÙˆØ¹',
                results: 'Ø§Ù„Ù†ØªØ§Ø¦Ø¬',
                startTyping: 'Ø§Ø¨Ø¯Ø£ Ø¨Ø§Ù„ÙƒØªØ§Ø¨Ø© Ù„Ù„Ø¨Ø­Ø«...',
                noResults: 'âŒ Ù„Ù… Ù†Ø¬Ø¯ Ù†Ø¨Ø§Øª ÙŠØ·Ø§Ø¨Ù‚ Ø§Ù„Ø¨Ø­Ø«',
                selectPlantFromList: 'Ø§Ø®ØªØ± Ø§Ù„Ù†Ø¨Ø§Øª Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©',
                soilQuality: 'Ø¬ÙˆØ¯Ø© Ø§Ù„ØªØ±Ø¨Ø©',
                suitablePlants: 'Ø§Ù„Ù†Ø¨Ø§ØªØ§Øª Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø©',
                solutions: 'Ø§Ù„ØªÙˆØµÙŠØ§Øª',
                compatibility: 'Ø§Ù„ØªÙˆØ§ÙÙ‚',
                enterData: 'ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª',
                loading: 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...',
                connected: 'âœ… Ù…ØªØµÙ„ Ø¨Ù†Ø¬Ø§Ø­',
                disconnected: 'âŒ ØºÙŠØ± Ù…ØªØµÙ„',
                autoFillEnabled: 'âœ… Ø§Ù„Ù…Ù„Ø¡ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù…ÙØ¹Ù„'
            },
            en: {
                title: 'ğŸŒ± Smart Soil Analyzer v5',
                selectMode: 'Select Analysis Mode',
                autoMode: 'ğŸ¤– Auto Analysis',
                autoFill: 'Auto Fill',
                manualMode: 'ğŸ” Manual Analysis',
                autoAnalysis: 'Auto Analysis',
                autoFillInfo: 'ğŸ’¡ Auto mode fills data from sensor automatically',
                autoFillAuto: 'Data fills automatically from sensor every 5 seconds',
                manualAnalysis: 'Manual Analysis',
                selectPlant: 'ğŸ” Search for Plant',
                enterData: 'Enter Soil Data',
                temperature: 'Temperature (Â°C)',
                moisture: 'Moisture (%)',
                ph: 'pH',
                nitrogen: 'Nitrogen (N)',
                phosphorus: 'Phosphorus (P)',
                potassium: 'Potassium (K)',
                analyze: 'ğŸ” Analyze',
                back: 'Back',
                results: 'Results',
                startTyping: 'Start typing to search...',
                noResults: 'âŒ No plants found',
                selectPlantFromList: 'Select a plant from the list',
                soilQuality: 'Soil Quality',
                suitablePlants: 'Suitable Plants',
                solutions: 'Recommendations',
                compatibility: 'Compatibility',
                enterData: 'Please enter all data',
                loading: 'Connecting...',
                connected: 'âœ… Connected',
                disconnected: 'âŒ Disconnected',
                autoFillEnabled: 'âœ… Auto Fill Enabled'
            },
            fr: {
                title: 'ğŸŒ± Analyseur de Sol Intelligent v5',
                selectMode: 'SÃ©lectionnez le mode d\'analyse',
                autoMode: 'ğŸ¤– Analyse Automatique',
                autoFill: 'Remplissage Automatique',
                manualMode: 'ğŸ” Analyse Manuelle',
                autoAnalysis: 'Analyse Automatique',
                autoFillInfo: 'ğŸ’¡ Le mode auto remplit les donnÃ©es du capteur automatiquement',
                autoFillAuto: 'Les donnÃ©es se remplissent automatiquement du capteur toutes les 5 secondes',
                manualAnalysis: 'Analyse Manuelle',
                selectPlant: 'ğŸ” Rechercher une Plante',
                enterData: 'Entrez les DonnÃ©es du Sol',
                temperature: 'TempÃ©rature (Â°C)',
                moisture: 'HumiditÃ© (%)',
                ph: 'pH',
                nitrogen: 'Azote (N)',
                phosphorus: 'Phosphore (P)',
                potassium: 'Potassium (K)',
                analyze: 'ğŸ” Analyser',
                back: 'Retour',
                results: 'RÃ©sultats',
                startTyping: 'Commencez Ã  taper pour rechercher...',
                noResults: 'âŒ Aucune plante trouvÃ©e',
                selectPlantFromList: 'SÃ©lectionnez une plante dans la liste',
                soilQuality: 'QualitÃ© du Sol',
                suitablePlants: 'Plantes AdaptÃ©es',
                solutions: 'Recommandations',
                compatibility: 'CompatibilitÃ©',
                enterData: 'Veuillez entrer toutes les donnÃ©es',
                loading: 'Connexion...',
                connected: 'âœ… ConnectÃ©',
                disconnected: 'âŒ DÃ©connectÃ©',
                autoFillEnabled: 'âœ… Remplissage Automatique ActivÃ©'
            },
            es: {
                title: 'ğŸŒ± Analizador Inteligente de Suelo v5',
                selectMode: 'Seleccionar Modo de AnÃ¡lisis',
                autoMode: 'ğŸ¤– AnÃ¡lisis AutomÃ¡tico',
                autoFill: 'Rellenado AutomÃ¡tico',
                manualMode: 'ğŸ” AnÃ¡lisis Manual',
                autoAnalysis: 'AnÃ¡lisis AutomÃ¡tico',
                autoFillInfo: 'ğŸ’¡ El modo automÃ¡tico rellena datos del sensor automÃ¡ticamente',
                autoFillAuto: 'Los datos se rellenan automÃ¡ticamente del sensor cada 5 segundos',
                manualAnalysis: 'AnÃ¡lisis Manual',
                selectPlant: 'ğŸ” Buscar Planta',
                enterData: 'Ingresar Datos del Suelo',
                temperature: 'Temperatura (Â°C)',
                moisture: 'Humedad (%)',
                ph: 'pH',
                nitrogen: 'NitrÃ³geno (N)',
                phosphorus: 'FÃ³sforo (P)',
                potassium: 'Potasio (K)',
                analyze: 'ğŸ” Analizar',
                back: 'AtrÃ¡s',
                results: 'Resultados',
                startTyping: 'Comience a escribir para buscar...',
                noResults: 'âŒ No se encontraron plantas',
                selectPlantFromList: 'Selecciona una planta de la lista',
                soilQuality: 'Calidad del Suelo',
                suitablePlants: 'Plantas Adecuadas',
                solutions: 'Recomendaciones',
                compatibility: 'Compatibilidad',
                enterData: 'Ingrese todos los datos',
                loading: 'Conectando...',
                connected: 'âœ… Conectado',
                disconnected: 'âŒ Desconectado',
                autoFillEnabled: 'âœ… Rellenado AutomÃ¡tico Habilitado'
            },
            de: {
                title: 'ğŸŒ± Intelligenter Bodenanalysator v5',
                selectMode: 'Analysemodus wÃ¤hlen',
                autoMode: 'ğŸ¤– Automatische Analyse',
                autoFill: 'Automatisches AusfÃ¼llen',
                manualMode: 'ğŸ” Manuelle Analyse',
                autoAnalysis: 'Automatische Analyse',
                autoFillInfo: 'ğŸ’¡ Der Automatikmodus fÃ¼llt Sensordaten automatisch aus',
                autoFillAuto: 'Daten werden alle 5 Sekunden automatisch vom Sensor ausgefÃ¼llt',
                manualAnalysis: 'Manuelle Analyse',
                selectPlant: 'ğŸ” Nach Pflanze suchen',
                enterData: 'Bodendaten eingeben',
                temperature: 'Temperatur (Â°C)',
                moisture: 'Feuchte (%)',
                ph: 'pH',
                nitrogen: 'Stickstoff (N)',
                phosphorus: 'Phosphor (P)',
                potassium: 'Kalium (K)',
                analyze: 'ğŸ” Analysieren',
                back: 'ZurÃ¼ck',
                results: 'Ergebnisse',
                startTyping: 'Zum Suchen eingeben...',
                noResults: 'âŒ Keine Pflanzen gefunden',
                selectPlantFromList: 'WÃ¤hlen Sie eine Pflanze aus der Liste',
                soilQuality: 'BodenqualitÃ¤t',
                suitablePlants: 'Geeignete Pflanzen',
                solutions: 'Empfehlungen',
                compatibility: 'KompatibilitÃ¤t',
                enterData: 'Bitte alle Daten eingeben',
                loading: 'Verbindung wird hergestellt...',
                connected: 'âœ… Verbunden',
                disconnected: 'âŒ Getrennt',
                autoFillEnabled: 'âœ… Automatisches AusfÃ¼llen Aktiviert'
            },
            zh: {
                title: 'ğŸŒ± æ™ºèƒ½åœŸå£¤åˆ†æä»ª v5',
                selectMode: 'é€‰æ‹©åˆ†ææ¨¡å¼',
                autoMode: 'ğŸ¤– è‡ªåŠ¨åˆ†æ',
                autoFill: 'è‡ªåŠ¨å¡«å……',
                manualMode: 'ğŸ” æ‰‹åŠ¨åˆ†æ',
                autoAnalysis: 'è‡ªåŠ¨åˆ†æ',
                autoFillInfo: 'ğŸ’¡ è‡ªåŠ¨æ¨¡å¼è‡ªåŠ¨å¡«å……ä¼ æ„Ÿå™¨æ•°æ®',
                autoFillAuto: 'ä¼ æ„Ÿå™¨æ•°æ®æ¯ 5 ç§’è‡ªåŠ¨å¡«å……',
                manualAnalysis: 'æ‰‹åŠ¨åˆ†æ',
                selectPlant: 'ğŸ” æœç´¢æ¤ç‰©',
                enterData: 'è¾“å…¥åœŸå£¤æ•°æ®',
                temperature: 'æ¸©åº¦ (Â°C)',
                moisture: 'æ¹¿åº¦ (%)',
                ph: 'pH å€¼',
                nitrogen: 'æ°® (N)',
                phosphorus: 'ç£· (P)',
                potassium: 'é’¾ (K)',
                analyze: 'ğŸ” åˆ†æ',
                back: 'è¿”å›',
                results: 'ç»“æœ',
                startTyping: 'å¼€å§‹è¾“å…¥ä»¥æœç´¢...',
                noResults: 'âŒ æœªæ‰¾åˆ°æ¤ç‰©',
                selectPlantFromList: 'ä»åˆ—è¡¨ä¸­é€‰æ‹©æ¤ç‰©',
                soilQuality: 'åœŸå£¤è´¨é‡',
                suitablePlants: 'é€‚åˆçš„æ¤ç‰©',
                solutions: 'å»ºè®®',
                compatibility: 'å…¼å®¹æ€§',
                enterData: 'è¯·è¾“å…¥æ‰€æœ‰æ•°æ®',
                loading: 'æ­£åœ¨è¿æ¥...',
                connected: 'âœ… å·²è¿æ¥',
                disconnected: 'âŒ å·²æ–­å¼€è¿æ¥',
                autoFillEnabled: 'âœ… è‡ªåŠ¨å¡«å……å·²å¯ç”¨'
            },
            ja: {
                title: 'ğŸŒ± ã‚¹ãƒãƒ¼ãƒˆåœŸå£Œåˆ†æè£…ç½® v5',
                selectMode: 'åˆ†æãƒ¢ãƒ¼ãƒ‰ã‚’é¸æŠ',
                autoMode: 'ğŸ¤– è‡ªå‹•åˆ†æ',
                autoFill: 'è‡ªå‹•å…¥åŠ›',
                manualMode: 'ğŸ” æ‰‹å‹•åˆ†æ',
                autoAnalysis: 'è‡ªå‹•åˆ†æ',
                autoFillInfo: 'ğŸ’¡ è‡ªå‹•ãƒ¢ãƒ¼ãƒ‰ã¯ã‚»ãƒ³ã‚µãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’è‡ªå‹•çš„ã«å…¥åŠ›ã—ã¾ã™',
                autoFillAuto: 'ã‚»ãƒ³ã‚µãƒ¼ãƒ‡ãƒ¼ã‚¿ã¯ 5 ç§’ã”ã¨ã«è‡ªå‹•çš„ã«å…¥åŠ›ã•ã‚Œã¾ã™',
                manualAnalysis: 'æ‰‹å‹•åˆ†æ',
                selectPlant: 'ğŸ” æ¤ç‰©ã‚’æ¤œç´¢',
                enterData: 'åœŸå£Œãƒ‡ãƒ¼ã‚¿ã‚’å…¥åŠ›',
                temperature: 'æ¸©åº¦ (Â°C)',
                moisture: 'æ¹¿åº¦ (%)',
                ph: 'pH',
                nitrogen: 'çª’ç´  (N)',
                phosphorus: 'ãƒªãƒ³ (P)',
                potassium: 'ã‚«ãƒªã‚¦ãƒ  (K)',
                analyze: 'ğŸ” åˆ†æ',
                back: 'æˆ»ã‚‹',
                results: 'çµæœ',
                startTyping: 'æ¤œç´¢ã‚’é–‹å§‹ã™ã‚‹ã«ã¯å…¥åŠ›ã—ã¦ãã ã•ã„...',
                noResults: 'âŒ æ¤ç‰©ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“',
                selectPlantFromList: 'ãƒªã‚¹ãƒˆã‹ã‚‰æ¤ç‰©ã‚’é¸æŠ',
                soilQuality: 'åœŸå£Œå“è³ª',
                suitablePlants: 'é©åˆ‡ãªæ¤ç‰©',
                solutions: 'æ¨å¥¨äº‹é …',
                compatibility: 'äº’æ›æ€§',
                enterData: 'ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„',
                loading: 'æ¥ç¶šä¸­...',
                connected: 'âœ… æ¥ç¶šæ¸ˆã¿',
                disconnected: 'âŒ åˆ‡æ–­',
                autoFillEnabled: 'âœ… è‡ªå‹•å…¥åŠ›ãŒæœ‰åŠ¹ã§ã™'
            },
            hi: {
                title: 'ğŸŒ± à¤¸à¥à¤®à¤¾à¤°à¥à¤Ÿ à¤®à¤¿à¤Ÿà¥à¤Ÿà¥€ à¤µà¤¿à¤¶à¥à¤²à¥‡à¤·à¤• v5',
                selectMode: 'à¤µà¤¿à¤¶à¥à¤²à¥‡à¤·à¤£ à¤®à¥‹à¤¡ à¤šà¥à¤¨à¥‡à¤‚',
                autoMode: 'ğŸ¤– à¤¸à¥à¤µà¤šà¤¾à¤²à¤¿à¤¤ à¤µà¤¿à¤¶à¥à¤²à¥‡à¤·à¤£',
                autoFill: 'à¤¸à¥à¤µà¤šà¤¾à¤²à¤¿à¤¤ à¤­à¤°à¤£',
                manualMode: 'ğŸ” à¤®à¥ˆà¤¨à¥à¤…à¤² à¤µà¤¿à¤¶à¥à¤²à¥‡à¤·à¤£',
                autoAnalysis: 'à¤¸à¥à¤µà¤šà¤¾à¤²à¤¿à¤¤ à¤µà¤¿à¤¶à¥à¤²à¥‡à¤·à¤£',
                autoFillInfo: 'ğŸ’¡ à¤‘à¤Ÿà¥‹ à¤®à¥‹à¤¡ à¤¸à¥‡à¤‚à¤¸à¤° à¤¡à¥‡à¤Ÿà¤¾ à¤¸à¥à¤µà¤šà¤¾à¤²à¤¿à¤¤ à¤°à¥‚à¤ª à¤¸à¥‡ à¤­à¤°à¤¤à¤¾ à¤¹à¥ˆ',
                autoFillAuto: 'à¤¸à¥‡à¤‚à¤¸à¤° à¤¡à¥‡à¤Ÿà¤¾ à¤¹à¤° 5 à¤¸à¥‡à¤•à¤‚à¤¡ à¤®à¥‡à¤‚ à¤¸à¥à¤µà¤šà¤¾à¤²à¤¿à¤¤ à¤°à¥‚à¤ª à¤¸à¥‡ à¤­à¤°à¤¾ à¤œà¤¾à¤¤à¤¾ à¤¹à¥ˆ',
                manualAnalysis: 'à¤®à¥ˆà¤¨à¥à¤…à¤² à¤µà¤¿à¤¶à¥à¤²à¥‡à¤·à¤£',
                selectPlant: 'ğŸ” à¤ªà¥Œà¤§à¥‡ à¤•à¥‹ à¤–à¥‹à¤œà¥‡à¤‚',
                enterData: 'à¤®à¤¿à¤Ÿà¥à¤Ÿà¥€ à¤•à¤¾ à¤¡à¥‡à¤Ÿà¤¾ à¤¦à¤°à¥à¤œ à¤•à¤°à¥‡à¤‚',
                temperature: 'à¤¤à¤¾à¤ªà¤®à¤¾à¤¨ (Â°C)',
                moisture: 'à¤†à¤°à¥à¤¦à¥à¤°à¤¤à¤¾ (%)',
                ph: 'pH',
                nitrogen: 'à¤¨à¤¾à¤‡à¤Ÿà¥à¤°à¥‹à¤œà¤¨ (N)',
                phosphorus: 'à¤«à¥‰à¤¸à¥à¤«à¥‹à¤°à¤¸ (P)',
                potassium: 'à¤ªà¥‹à¤Ÿà¥‡à¤¶à¤¿à¤¯à¤® (K)',
                analyze: 'ğŸ” à¤µà¤¿à¤¶à¥à¤²à¥‡à¤·à¤£',
                back: 'à¤µà¤¾à¤ªà¤¸',
                results: 'à¤ªà¤°à¤¿à¤£à¤¾à¤®',
                startTyping: 'à¤–à¥‹à¤œà¤¨à¥‡ à¤•à¥‡ à¤²à¤¿à¤ à¤Ÿà¤¾à¤‡à¤ª à¤•à¤°à¤¨à¤¾ à¤¶à¥à¤°à¥‚ à¤•à¤°à¥‡à¤‚...',
                noResults: 'âŒ à¤•à¥‹à¤ˆ à¤ªà¥Œà¤§à¤¾ à¤¨à¤¹à¥€à¤‚ à¤®à¤¿à¤²à¤¾',
                selectPlantFromList: 'à¤¸à¥‚à¤šà¥€ à¤¸à¥‡ à¤ªà¥Œà¤§à¤¾ à¤šà¥à¤¨à¥‡à¤‚',
                soilQuality: 'à¤®à¤¿à¤Ÿà¥à¤Ÿà¥€ à¤•à¥€ à¤—à¥à¤£à¤µà¤¤à¥à¤¤à¤¾',
                suitablePlants: 'à¤‰à¤ªà¤¯à¥à¤•à¥à¤¤ à¤ªà¥Œà¤§à¥‡',
                solutions: 'à¤¸à¥à¤à¤¾à¤µ',
                compatibility: 'à¤…à¤¨à¥à¤•à¥‚à¤²à¤¤à¤¾',
                enterData: 'à¤•à¥ƒà¤ªà¤¯à¤¾ à¤¸à¤­à¥€ à¤¡à¥‡à¤Ÿà¤¾ à¤¦à¤°à¥à¤œ à¤•à¤°à¥‡à¤‚',
                loading: 'à¤•à¤¨à¥‡à¤•à¥à¤Ÿ à¤¹à¥‹ à¤°à¤¹à¤¾ à¤¹à¥ˆ...',
                connected: 'âœ… à¤•à¤¨à¥‡à¤•à¥à¤Ÿà¥‡à¤¡',
                disconnected: 'âŒ à¤¡à¤¿à¤¸à¥à¤•à¤¨à¥‡à¤•à¥à¤Ÿà¥‡à¤¡',
                autoFillEnabled: 'âœ… à¤¸à¥à¤µà¤šà¤¾à¤²à¤¿à¤¤ à¤­à¤°à¤£ à¤¸à¤•à¥à¤·à¤®'
            },
            tr: {
                title: 'ğŸŒ± AkÄ±llÄ± Toprak Analiz CihazÄ± v5',
                selectMode: 'Analiz Modunu SeÃ§in',
                autoMode: 'ğŸ¤– Otomatik Analiz',
                autoFill: 'Otomatik Doldurma',
                manualMode: 'ğŸ” Manuel Analiz',
                autoAnalysis: 'Otomatik Analiz',
                autoFillInfo: 'ğŸ’¡ Oto mod sensÃ¶r verilerini otomatik olarak doldurur',
                autoFillAuto: 'SensÃ¶r verileri her 5 saniyede otomatik olarak doldurulur',
                manualAnalysis: 'Manuel Analiz',
                selectPlant: 'ğŸ” Bitki Ara',
                enterData: 'Toprak Verilerini Girin',
                temperature: 'SÄ±caklÄ±k (Â°C)',
                moisture: 'Nem (%)',
                ph: 'pH',
                nitrogen: 'Azot (N)',
                phosphorus: 'Fosfor (P)',
                potassium: 'Potasyum (K)',
                analyze: 'ğŸ” Analiz',
                back: 'Geri',
                results: 'SonuÃ§lar',
                startTyping: 'Aramaya baÅŸlamak iÃ§in yazÄ±n...',
                noResults: 'âŒ Bitki bulunamadÄ±',
                selectPlantFromList: 'Listeden bir bitki seÃ§in',
                soilQuality: 'Toprak Kalitesi',
                suitablePlants: 'Uygun Bitkiler',
                solutions: 'Ã–neriler',
                compatibility: 'Uyumluluk',
                enterData: 'LÃ¼tfen tÃ¼m verileri girin',
                loading: 'BaÄŸlanÄ±yor...',
                connected: 'âœ… BaÄŸlÄ±',
                disconnected: 'âŒ BaÄŸlÄ± DeÄŸil',
                autoFillEnabled: 'âœ… Otomatik Doldurma Etkin'
            },
            pt: {
                title: 'ğŸŒ± Analisador Inteligente de Solo v5',
                selectMode: 'Selecione o Modo de AnÃ¡lise',
                autoMode: 'ğŸ¤– AnÃ¡lise AutomÃ¡tica',
                autoFill: 'Preenchimento AutomÃ¡tico',
                manualMode: 'ğŸ” AnÃ¡lise Manual',
                autoAnalysis: 'AnÃ¡lise AutomÃ¡tica',
                autoFillInfo: 'ğŸ’¡ O modo automÃ¡tico preenche dados do sensor automaticamente',
                autoFillAuto: 'Os dados do sensor sÃ£o preenchidos automaticamente a cada 5 segundos',
                manualAnalysis: 'AnÃ¡lise Manual',
                selectPlant: 'ğŸ” Pesquisar Planta',
                enterData: 'Insira Dados do Solo',
                temperature: 'Temperatura (Â°C)',
                moisture: 'Umidade (%)',
                ph: 'pH',
                nitrogen: 'NitrogÃªnio (N)',
                phosphorus: 'FÃ³sforo (P)',
                potassium: 'PotÃ¡ssio (K)',
                analyze: 'ğŸ” Analisar',
                back: 'Voltar',
                results: 'Resultados',
                startTyping: 'Comece a digitar para pesquisar...',
                noResults: 'âŒ Nenhuma planta encontrada',
                selectPlantFromList: 'Selecione uma planta da lista',
                soilQuality: 'Qualidade do Solo',
                suitablePlants: 'Plantas Adequadas',
                solutions: 'RecomendaÃ§Ãµes',
                compatibility: 'Compatibilidade',
                enterData: 'Por favor, insira todos os dados',
                loading: 'Conectando...',
                connected: 'âœ… Conectado',
                disconnected: 'âŒ Desconectado',
                autoFillEnabled: 'âœ… Preenchimento AutomÃ¡tico Ativado'
            }
        };

        // Update text elements based on current language
        function updateText() {
            const t = translations[currentLanguage];
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (t[key]) {
                    el.textContent = t[key];
                }
            });
            
            // Set text direction
            document.documentElement.dir = currentLanguage === 'ar' ? 'rtl' : 'ltr';
        }

        // Create language selector buttons
        function createLanguageSelector() {
            const dropdown = document.getElementById('languageDropdown');
            if (dropdown) {
                dropdown.value = currentLanguage;
            }
        }

        // Change language
        function changeLanguage(lang) {
            currentLanguage = lang;
            updateText();
            createLanguageSelector();
            updateConnectionStatus();
        }

        // Connect to bridge and auto-populate data
        function connectToBridge() {
            try {
                const ws = new WebSocket('ws://localhost:3000');
                
                ws.onopen = function() {
                    console.log('âœ… Bridge connected');
                    bridgeConnected = true;
                    updateConnectionStatus();
                };
                
                ws.onmessage = function(event) {
                    try {
                        const data = JSON.parse(event.data);
                        
                        // Store data for manual mode
                        lastBridgeData = data;
                        
                        // Auto-populate auto analysis form
                        if (document.getElementById('autoTemp')) {
                            document.getElementById('autoTemp').value = data.temperature?.toFixed(1) || '';
                            document.getElementById('autoMoisture').value = data.moisture?.toFixed(1) || '';
                            document.getElementById('autoPh').value = data.pH?.toFixed(1) || '';
                            document.getElementById('autoNitrogen').value = data.nitrogen?.toFixed(0) || '';
                            document.getElementById('autoPhosphorus').value = data.phosphorus?.toFixed(0) || '';
                            document.getElementById('autoPotassium').value = data.potassium?.toFixed(0) || '';
                        }
                    } catch (e) {
                        console.error('Error parsing bridge data:', e);
                    }
                };
                
                ws.onerror = function() {
                    bridgeConnected = false;
                    updateConnectionStatus();
                };
                
                ws.onclose = function() {
                    bridgeConnected = false;
                    updateConnectionStatus();
                    // Reconnect after 3 seconds
                    setTimeout(connectToBridge, 3000);
                };
            } catch (e) {
                console.error('Bridge connection error:', e);
            }
        }

        // Update connection status display
        function updateConnectionStatus() {
            const t = translations[currentLanguage];
            const status = document.getElementById('connectionStatus');
            if (status) {
                if (bridgeConnected) {
                    status.className = 'connected';
                    status.textContent = t.connected || 'âœ… Connected';
                } else {
                    status.className = 'disconnected';
                    status.textContent = t.disconnected || 'âŒ Disconnected';
                }
            }
        }

        // Screen switching functions
        function switchToMode() {
            stopAutoFillManualMode();
            hideAllScreens();
            document.getElementById('modeScreen').classList.add('active');
        }

        function switchToAutoAnalysis() {
            stopAutoFillManualMode();
            hideAllScreens();
            document.getElementById('autoScreen').classList.add('active');
        }

        function switchToManualSearch() {
            stopAutoFillManualMode();
            hideAllScreens();
            document.getElementById('manualSearchScreen').classList.add('active');
            document.getElementById('plantSearchInput').value = '';
            document.getElementById('searchResultsContainer').innerHTML = `
                <div class="result-item" style="text-align: center; color: #999;">
                    <span data-i18n="startTyping">Ø§Ø¨Ø¯Ø£ Ø¨Ø§Ù„ÙƒØªØ§Ø¨Ø© Ù„Ù„Ø¨Ø­Ø«...</span>
                </div>
            `;
            updateText();
        }

        function switchToManualAnalysis() {
            hideAllScreens();
            document.getElementById('manualAnalysisScreen').classList.add('active');
            // Start auto-fill when entering manual analysis
            startAutoFillManualMode();
        }

        function hideAllScreens() {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
        }

        // Handle plant search
        function handlePlantSearch(e) {
            const t = translations[currentLanguage];
            const query = e.target.value.toLowerCase().trim();
            const resultsContainer = document.getElementById('searchResultsContainer');
            
            console.log('Search query:', query, 'Current language:', currentLanguage);
            
            if (!query) {
                resultsContainer.innerHTML = `<div class="result-item" style="text-align: center; color: #999;"><span>${t.startTyping}</span></div>`;
                return;
            }

            // Use plantsDB directly since all plants are already there
            const results = plantsDB.plants.filter(plant => {
                const arabicName = plant.nameAr ? plant.nameAr.toLowerCase() : '';
                const englishName = plant.nameEn ? plant.nameEn.toLowerCase() : '';
                const mainName = plant.name ? plant.name.toLowerCase() : '';
                
                return arabicName.includes(query) || englishName.includes(query) || mainName.includes(query);
            }).slice(0, 20);

            console.log('Search results:', results.length);

            if (results.length === 0) {
                resultsContainer.innerHTML = `<div class="result-item" style="text-align: center; color: #999;"><span>${t.noResults}</span></div>`;
                return;
            }

            resultsContainer.innerHTML = results.map(plant => {
                // Get plant name based on current language
                let displayName = plant.nameAr || plant.nameEn || plant.name || 'Ù†Ø¨Ø§Øª';
                
                // Try to translate based on current language
                if (currentLanguage === 'en' && plant.nameEn) {
                    displayName = plant.nameEn;
                } else if (currentLanguage === 'fr' && plant.nameFr) {
                    displayName = plant.nameFr;
                } else if (currentLanguage === 'es' && plant.nameEs) {
                    displayName = plant.nameEs;
                } else if (currentLanguage === 'de' && plant.nameDe) {
                    displayName = plant.nameDe;
                }
                
                return `
                <div class="result-item" onclick="selectPlantFromSearch(${plant.id})">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span style="font-size: 24px;">${plant.emoji || 'ğŸŒ±'}</span>
                        <div style="flex: 1;">
                            <div class="plant-name">${displayName}</div>
                            <div class="plant-temp">T: ${plant.tempMin || 15}Â°-${plant.tempMax || 28}Â°C</div>
                        </div>
                    </div>
                </div>
            `;
            }).join('');
        }

        // Select plant from search
        function selectPlantFromSearch(plantId) {
            currentSelectedPlant = plantsDB.plants.find(p => p.id === plantId);
            if (currentSelectedPlant) {
                const info = document.getElementById('selectedPlantInfo');
                const t = translations[currentLanguage];
                
                // Get plant name based on current language
                let plantName = currentSelectedPlant.nameAr || currentSelectedPlant.nameEn || currentSelectedPlant.name || 'Ù†Ø¨Ø§Øª';
                if (currentLanguage === 'en' && currentSelectedPlant.nameEn) {
                    plantName = currentSelectedPlant.nameEn;
                } else if (currentLanguage === 'fr' && currentSelectedPlant.nameFr) {
                    plantName = currentSelectedPlant.nameFr;
                } else if (currentLanguage === 'es' && currentSelectedPlant.nameEs) {
                    plantName = currentSelectedPlant.nameEs;
                } else if (currentLanguage === 'de' && currentSelectedPlant.nameDe) {
                    plantName = currentSelectedPlant.nameDe;
                }
                
                const tempLabel = currentLanguage === 'ar' ? 'Ø¯Ø±Ø¬Ø© Ø§Ù„Ø­Ø±Ø§Ø±Ø©' : 
                                   currentLanguage === 'en' ? 'Temperature' :
                                   currentLanguage === 'fr' ? 'TempÃ©rature' :
                                   currentLanguage === 'es' ? 'Temperatura' :
                                   currentLanguage === 'de' ? 'Temperatur' :
                                   currentLanguage === 'zh' ? 'æ¸©åº¦' :
                                   currentLanguage === 'ja' ? 'æ¸©åº¦' :
                                   currentLanguage === 'hi' ? 'à¤¤à¤¾à¤ªà¤®à¤¾à¤¨' :
                                   currentLanguage === 'tr' ? 'SÄ±caklÄ±k' :
                                   currentLanguage === 'pt' ? 'Temperatura' : 'Temperature';
                info.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <span style="font-size: 40px;">${currentSelectedPlant.emoji || 'ğŸŒ±'}</span>
                        <div>
                            <h3>${plantName}</h3>
                            <p style="font-size: 12px; color: #666;">${tempLabel}: ${currentSelectedPlant.tempMin || 15}Â°-${currentSelectedPlant.tempMax || 28}Â°C</p>
                        </div>
                    </div>
                `;
                
                console.log('Plant selected:', plantName);
                
                // Auto-populate manual analysis with current sensor data
                startAutoFillManualMode();
                switchToManualAnalysis();
            }
        }
        
        // Auto-fill manual analysis fields every 5 seconds
        let manualAutoFillInterval = null;
        
        function startAutoFillManualMode() {
            // Clear any existing interval
            if (manualAutoFillInterval) {
                clearInterval(manualAutoFillInterval);
            }
            
            // Fill immediately
            autoFillManualFields();
            
            // Then fill every 5 seconds
            manualAutoFillInterval = setInterval(autoFillManualFields, 5000);
        }
        
        function autoFillManualFields() {
            // Get the last data from bridge
            if (lastBridgeData) {
                const tempInput = document.getElementById('manualTemp');
                const moistureInput = document.getElementById('manualMoisture');
                const phInput = document.getElementById('manualPh');
                const nitrogenInput = document.getElementById('manualNitrogen');
                const phosphorusInput = document.getElementById('manualPhosphorus');
                const potassiumInput = document.getElementById('manualPotassium');
                
                // Only fill if the field is empty
                if (tempInput && (!tempInput.value || tempInput.value === '')) {
                    tempInput.value = lastBridgeData.temperature?.toFixed(1) || '';
                }
                if (moistureInput && (!moistureInput.value || moistureInput.value === '')) {
                    moistureInput.value = lastBridgeData.moisture?.toFixed(1) || '';
                }
                if (phInput && (!phInput.value || phInput.value === '')) {
                    phInput.value = lastBridgeData.pH?.toFixed(1) || '';
                }
                if (nitrogenInput && (!nitrogenInput.value || nitrogenInput.value === '')) {
                    nitrogenInput.value = lastBridgeData.nitrogen?.toFixed(0) || '';
                }
                if (phosphorusInput && (!phosphorusInput.value || phosphorusInput.value === '')) {
                    phosphorusInput.value = lastBridgeData.phosphorus?.toFixed(0) || '';
                }
                if (potassiumInput && (!potassiumInput.value || potassiumInput.value === '')) {
                    potassiumInput.value = lastBridgeData.potassium?.toFixed(0) || '';
                }
                
                console.log('Manual fields auto-filled');
            }
        }
        
        function stopAutoFillManualMode() {
            if (manualAutoFillInterval) {
                clearInterval(manualAutoFillInterval);
                manualAutoFillInterval = null;
            }
        }

        // Analyze auto data
        function analyzeAutoData() {
            const t = translations[currentLanguage];
            const temp = parseFloat(document.getElementById('autoTemp').value);
            const moisture = parseFloat(document.getElementById('autoMoisture').value);
            const ph = parseFloat(document.getElementById('autoPh').value);
            const nitrogen = parseFloat(document.getElementById('autoNitrogen').value);
            const phosphorus = parseFloat(document.getElementById('autoPhosphorus').value);
            const potassium = parseFloat(document.getElementById('autoPotassium').value);

            if (!temp || !moisture || !ph) {
                alert(t.enterData || 'âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©');
                return;
            }

            const analysis = aiAnalyzer.analyzeAutomatic({
                temperature: temp,
                moisture: moisture,
                pH: ph,
                nitrogen: nitrogen || 0,
                phosphorus: phosphorus || 0,
                potassium: potassium || 0
            });

            displayResults(analysis);
        }

        // Analyze manual data with soil compatibility checking
        function analyzeManualData() {
            const t = translations[currentLanguage];
            
            // Validate that a plant is selected
            if (!currentSelectedPlant) {
                alert(currentLanguage === 'ar' ? 'âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù†Ø¨Ø§Øª Ø£ÙˆÙ„Ø§Ù‹' : 'âš ï¸ Please select a plant first');
                return;
            }
            
            // Get values and trim whitespace
            const tempStr = document.getElementById('manualTemp').value.trim();
            const moistureStr = document.getElementById('manualMoisture').value.trim();
            const phStr = document.getElementById('manualPh').value.trim();
            
            // Parse values
            const temp = tempStr ? parseFloat(tempStr) : NaN;
            const moisture = moistureStr ? parseFloat(moistureStr) : NaN;
            const ph = phStr ? parseFloat(phStr) : NaN;
            const nitrogen = document.getElementById('manualNitrogen').value.trim() ? parseFloat(document.getElementById('manualNitrogen').value.trim()) : 0;
            const phosphorus = document.getElementById('manualPhosphorus').value.trim() ? parseFloat(document.getElementById('manualPhosphorus').value.trim()) : 0;
            const potassium = document.getElementById('manualPotassium').value.trim() ? parseFloat(document.getElementById('manualPotassium').value.trim()) : 0;

            console.log('Raw values:', { tempStr, moistureStr, phStr });
            console.log('Parsed values:', { temp, moisture, ph, nitrogen, phosphorus, potassium });

            // Check if values are valid numbers
            if (isNaN(temp) || isNaN(moisture) || isNaN(ph)) {
                alert(currentLanguage === 'ar' ? 
                    `âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù‚ÙŠÙ… ØµØ­ÙŠØ­Ø©\nØ¯Ø±Ø¬Ø© Ø§Ù„Ø­Ø±Ø§Ø±Ø©: ${tempStr || 'ÙØ§Ø±Øº'}\nØ§Ù„Ø±Ø·ÙˆØ¨Ø©: ${moistureStr || 'ÙØ§Ø±Øº'}\npH: ${phStr || 'ÙØ§Ø±Øº'}` : 
                    `âš ï¸ Please enter valid values\nTemperature: ${tempStr || 'empty'}\nMoisture: ${moistureStr || 'empty'}\npH: ${phStr || 'empty'}`);
                return;
            }

            // Check if values are in reasonable ranges
            if (temp < -50 || temp > 60 || moisture < 0 || moisture > 100 || ph < 0 || ph > 14) {
                alert(currentLanguage === 'ar' ? 
                    `âš ï¸ Ø§Ù„Ù‚ÙŠÙ… Ø®Ø§Ø±Ø¬ Ø§Ù„Ù†Ø·Ø§Ù‚ Ø§Ù„Ù…Ù‚Ø¨ÙˆÙ„:\nØ¯Ø±Ø¬Ø© Ø§Ù„Ø­Ø±Ø§Ø±Ø©: ${temp}Â°C (ÙŠØ¬Ø¨: -50 Ø¥Ù„Ù‰ 60)\nØ§Ù„Ø±Ø·ÙˆØ¨Ø©: ${moisture}% (ÙŠØ¬Ø¨: 0 Ø¥Ù„Ù‰ 100)\npH: ${ph} (ÙŠØ¬Ø¨: 0 Ø¥Ù„Ù‰ 14)` : 
                    `âš ï¸ Values out of acceptable range:\nTemperature: ${temp}Â°C (should be: -50 to 60)\nMoisture: ${moisture}% (should be: 0 to 100)\npH: ${ph} (should be: 0 to 14)`);
                return;
            }

            // Check soil compatibility with selected plant
            const soilData = {
                temperature: temp,
                moisture: moisture,
                pH: ph,
                nitrogen: nitrogen || 0,
                phosphorus: phosphorus || 0,
                potassium: potassium || 0
            };

            console.log('Plant selected:', currentSelectedPlant.nameAr || currentSelectedPlant.nameEn);
            console.log('Soil data:', soilData);

            // Compare with plant requirements
            const compatibility = checkPlantSoilCompatibility(currentSelectedPlant, soilData);
            console.log('Compatibility:', compatibility);
            
            // Get AI recommendations for improvements
            let aiRecommendations = [];
            if (!compatibility.isFullyCompatible) {
                aiRecommendations = getAIRecommendations(currentSelectedPlant, soilData, compatibility);
            }

            // Display comprehensive results
            displayManualAnalysisResults(compatibility, aiRecommendations, soilData);
        }

        // Check if soil is compatible with plant requirements
        function checkPlantSoilCompatibility(plant, soilData) {
            const compatibility = {
                isFullyCompatible: true,
                issues: [],
                recommendations: [],
                soilQuality: 100,
                plant: plant
            };

            // Temperature check
            if (soilData.temperature < plant.tempMin || soilData.temperature > plant.tempMax) {
                compatibility.isFullyCompatible = false;
                compatibility.issues.push({
                    type: 'temperature',
                    current: soilData.temperature,
                    ideal: `${plant.tempMin}Â°-${plant.tempMax}Â°C`,
                    severity: 'high'
                });
                compatibility.soilQuality -= 20;
            }

            // Moisture check
            if (soilData.moisture < (plant.moistureMin || 50) || soilData.moisture > (plant.moistureMax || 80)) {
                compatibility.isFullyCompatible = false;
                compatibility.issues.push({
                    type: 'moisture',
                    current: soilData.moisture,
                    ideal: `${plant.moistureMin || 50}%-${plant.moistureMax || 80}%`,
                    severity: 'high'
                });
                compatibility.soilQuality -= 20;
            }

            // pH check
            if (soilData.pH < plant.phMin || soilData.pH > plant.phMax) {
                compatibility.isFullyCompatible = false;
                compatibility.issues.push({
                    type: 'pH',
                    current: soilData.pH,
                    ideal: `${plant.phMin}-${plant.phMax}`,
                    severity: soilData.pH < plant.phMin ? 'acidic' : 'alkaline'
                });
                compatibility.soilQuality -= 20;
            }

            // Nitrogen check
            if (soilData.nitrogen < 30) {
                compatibility.isFullyCompatible = false;
                compatibility.issues.push({
                    type: 'nitrogen',
                    current: soilData.nitrogen,
                    ideal: 50,
                    severity: 'medium'
                });
                compatibility.soilQuality -= 10;
            }

            // Phosphorus check
            if (soilData.phosphorus < 20) {
                compatibility.isFullyCompatible = false;
                compatibility.issues.push({
                    type: 'phosphorus',
                    current: soilData.phosphorus,
                    ideal: 40,
                    severity: 'medium'
                });
                compatibility.soilQuality -= 10;
            }

            // Potassium check
            if (soilData.potassium < 20) {
                compatibility.isFullyCompatible = false;
                compatibility.issues.push({
                    type: 'potassium',
                    current: soilData.potassium,
                    ideal: 30,
                    severity: 'medium'
                });
                compatibility.soilQuality -= 10;
            }

            return compatibility;
        }

        // Get AI recommendations for soil improvements
        function getAIRecommendations(plant, soilData, compatibility) {
            const recommendations = [];
            const plantName = plant.nameAr || plant.nameEn || 'Ø§Ù„Ù†Ø¨Ø§Øª';

            // Temperature recommendations
            const tempIssue = compatibility.issues.find(i => i.type === 'temperature');
            if (tempIssue) {
                recommendations.push({
                    type: 'temperature',
                    title: currentLanguage === 'ar' ? 'ğŸŒ¡ï¸ Ø¯Ø±Ø¬Ø© Ø§Ù„Ø­Ø±Ø§Ø±Ø©' : 'ğŸŒ¡ï¸ Temperature',
                    issue: currentLanguage === 'ar' ? 
                        `Ø§Ù„Ø­Ø§Ù„ÙŠØ©: ${tempIssue.current}Â°CØŒ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©: ${tempIssue.ideal}` :
                        `Current: ${tempIssue.current}Â°C, Required: ${tempIssue.ideal}`,
                    solutions: currentLanguage === 'ar' ? [
                        soilData.temperature < plant.tempMin ? 
                            `ğŸ”¥ Ø²ÙŠØ§Ø¯Ø© Ø¯Ø±Ø¬Ø© Ø§Ù„Ø­Ø±Ø§Ø±Ø©: Ø§Ø³ØªØ®Ø¯Ù… ØºØ·Ø§Ø¡ Ø¨Ù„Ø§Ø³ØªÙŠÙƒÙŠ Ø£Ùˆ Ø¶Ø¹ Ø§Ù„Ù†Ø¨Ø§Øª ÙÙŠ Ù…ÙƒØ§Ù† Ø£ÙƒØ«Ø± Ø¯ÙØ¦Ø§Ù‹` :
                            `â„ï¸ ØªÙ‚Ù„ÙŠÙ„ Ø¯Ø±Ø¬Ø© Ø§Ù„Ø­Ø±Ø§Ø±Ø©: Ø­Ø³Ù‘Ù† Ø§Ù„ØªÙ‡ÙˆÙŠØ© ÙˆÙ‚Ù„Ù„ Ø§Ù„ØªØ¹Ø±ÙŠØ¶ Ø§Ù„Ù…Ø¨Ø§Ø´Ø± Ù„Ù„Ø´Ù…Ø³`,
                        `ğŸ’¨ ØªØ­Ø³ÙŠÙ† Ø§Ù„ØªÙ‡ÙˆÙŠØ© Ø­ÙˆÙ„ Ø§Ù„Ù†Ø¨Ø§Øª`
                    ] : [
                        soilData.temperature < plant.tempMin ? 
                            `ğŸ”¥ Increase temperature: Use plastic cover or place in warmer location` :
                            `â„ï¸ Decrease temperature: Improve ventilation and reduce direct sun exposure`,
                        `ğŸ’¨ Improve air circulation around the plant`
                    ]
                });
            }

            // Moisture recommendations
            const moistureIssue = compatibility.issues.find(i => i.type === 'moisture');
            if (moistureIssue) {
                recommendations.push({
                    type: 'moisture',
                    title: currentLanguage === 'ar' ? 'ğŸ’§ Ø§Ù„Ø±Ø·ÙˆØ¨Ø©' : 'ğŸ’§ Moisture',
                    issue: currentLanguage === 'ar' ? 
                        `Ø§Ù„Ø­Ø§Ù„ÙŠØ©: ${moistureIssue.current}%ØŒ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©: ${moistureIssue.ideal}` :
                        `Current: ${moistureIssue.current}%, Required: ${moistureIssue.ideal}`,
                    solutions: currentLanguage === 'ar' ? [
                        soilData.moisture < (plant.moistureMin || 50) ? 
                            `ğŸ’§ Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ø±Ø·ÙˆØ¨Ø©: Ø§Ø³Ù‚Ù Ø§Ù„Ù†Ø¨Ø§Øª Ø£ÙƒØ«Ø± ÙˆØ£Ø¶Ù Ø·Ø¨Ù‚Ø© Ù…Ù† Ø§Ù„Ù…Ø§Ù„ØªØ´` :
                            `ğŸŒ³ ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø±Ø·ÙˆØ¨Ø©: Ù‚Ù„Ù„ Ø§Ù„ØªØ³Ù‚ÙŠØ© ÙˆØ­Ø³Ù‘Ù† ØªØµØ±ÙŠÙ Ø§Ù„Ù…ÙŠØ§Ù‡`,
                        `ğŸª´ Ø§Ø³ØªØ®Ø¯Ù… ØªØ±Ø¨Ø© Ø°Ø§Øª Ù‚Ø¯Ø±Ø© ØªØµØ±ÙŠÙ Ø£ÙØ¶Ù„`
                    ] : [
                        soilData.moisture < (plant.moistureMin || 50) ? 
                            `ğŸ’§ Increase moisture: Water more frequently and add mulch layer` :
                            `ğŸŒ³ Decrease moisture: Reduce watering and improve drainage`,
                        `ğŸª´ Use soil with better drainage capacity`
                    ]
                });
            }

            // pH recommendations
            const phIssue = compatibility.issues.find(i => i.type === 'pH');
            if (phIssue) {
                recommendations.push({
                    type: 'pH',
                    title: currentLanguage === 'ar' ? 'âš—ï¸ Ø¯Ø±Ø¬Ø© Ø§Ù„Ø­Ù…ÙˆØ¶Ø© (pH)' : 'âš—ï¸ Soil pH',
                    issue: currentLanguage === 'ar' ? 
                        `Ø§Ù„Ø­Ø§Ù„ÙŠØ©: ${phIssue.current}, Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©: ${phIssue.ideal}` :
                        `Current: ${phIssue.current}, Required: ${phIssue.ideal}`,
                    solutions: currentLanguage === 'ar' ? [
                        phIssue.severity === 'acidic' ? 
                            `ğŸ¥— Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ø­Ù…ÙˆØ¶Ø©: Ø£Ø¶Ù Ø§Ù„Ø­Ø¬Ø± Ø§Ù„Ø¬ÙŠØ±ÙŠ (Lime) Ø£Ùˆ Ø§Ù„Ø±Ù…Ø§Ø¯` :
                            `ğŸ‹ ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø­Ù…ÙˆØ¶Ø©: Ø£Ø¶Ù Ø§Ù„ÙƒØ¨Ø±ÙŠØª Ø£Ùˆ Ø§Ù„Ù…Ø§Ø¯Ø© Ø§Ù„Ø¹Ø¶ÙˆÙŠØ© (Peat Moss)`,
                        `ğŸŒ± Ø§Ù„Ù…ÙˆØ§Ø²Ù†Ø©: Ø£Ø¶Ù Ø§Ù„Ø³Ù…Ø§Ø¯ Ø§Ù„Ø¹Ø¶ÙˆÙŠ ØªØ¯Ø±ÙŠØ¬ÙŠØ§Ù‹`
                    ] : [
                        phIssue.severity === 'acidic' ? 
                            `ğŸ¥— Increase pH: Add Lime or wood ash` :
                            `ğŸ‹ Decrease pH: Add Sulfur or organic matter (Peat Moss)`,
                        `ğŸŒ± Balance: Add organic compost gradually`
                    ]
                });
            }

            // Nitrogen recommendations
            const nitrogenIssue = compatibility.issues.find(i => i.type === 'nitrogen');
            if (nitrogenIssue) {
                recommendations.push({
                    type: 'nitrogen',
                    title: currentLanguage === 'ar' ? 'ğŸŒ¿ Ø§Ù„Ù†ÙŠØªØ±ÙˆØ¬ÙŠÙ† (N)' : 'ğŸŒ¿ Nitrogen (N)',
                    issue: currentLanguage === 'ar' ? 
                        `Ø§Ù„Ù†ÙŠØªØ±ÙˆØ¬ÙŠÙ† Ù…Ù†Ø®ÙØ¶ Ø¬Ø¯Ø§Ù‹: ${nitrogenIssue.current} (Ø§Ù„Ù…Ø·Ù„ÙˆØ¨: ${nitrogenIssue.ideal})` :
                        `Nitrogen too low: ${nitrogenIssue.current} (Required: ${nitrogenIssue.ideal})`,
                    solutions: currentLanguage === 'ar' ? [
                        `ğŸŒ¾ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø³Ù…Ø§Ø¯ Ø§Ù„Ù†ÙŠØªØ±ÙˆØ¬ÙŠÙ†ÙŠ: Ø£Ø¶Ù Ø³Ù…Ø§Ø¯ Ø§Ù„ÙŠÙˆØ±ÙŠØ§ Ø£Ùˆ Ø³Ù…Ø§Ø¯ Ø¹Ø¶ÙˆÙŠ ØºÙ†ÙŠ Ø¨Ø§Ù„Ù†ÙŠØªØ±ÙˆØ¬ÙŠÙ†`,
                        `ğŸª¨ Ø§Ø³ØªØ®Ø¯Ù… Ø³Ù…Ø§Ø¯ Ø§Ù„Ø¨Ù‚Ø±Ø© Ø£Ùˆ Ø§Ù„Ø¯ÙˆØ§Ø¬Ù† Ø§Ù„Ù…ØªØ­Ù„Ù„`,
                        `ğŸŒ± Ø²Ø±Ø¹ Ù†Ø¨Ø§ØªØ§Øª ÙØ§ØµÙˆÙ„ÙŠØ§ Ø£Ùˆ Ø¨Ø±Ø³ÙŠÙ… Ù„ØªØ«Ø¨ÙŠØª Ø§Ù„Ù†ÙŠØªØ±ÙˆØ¬ÙŠÙ† Ø¨Ø´ÙƒÙ„ Ø·Ø¨ÙŠØ¹ÙŠ`
                    ] : [
                        `ğŸŒ¾ Add nitrogen fertilizer: Use urea or organic nitrogen-rich fertilizer`,
                        `ğŸª¨ Use decomposed cow or chicken manure`,
                        `ğŸŒ± Plant legumes (beans, alfalfa) to naturally fix nitrogen`
                    ]
                });
            }

            // Phosphorus recommendations
            const phosphorusIssue = compatibility.issues.find(i => i.type === 'phosphorus');
            if (phosphorusIssue) {
                recommendations.push({
                    type: 'phosphorus',
                    title: currentLanguage === 'ar' ? 'âš¡ Ø§Ù„ÙØ³ÙÙˆØ± (P)' : 'âš¡ Phosphorus (P)',
                    issue: currentLanguage === 'ar' ? 
                        `Ø§Ù„ÙØ³ÙÙˆØ± Ù…Ù†Ø®ÙØ¶: ${phosphorusIssue.current} (Ø§Ù„Ù…Ø·Ù„ÙˆØ¨: ${phosphorusIssue.ideal})` :
                        `Phosphorus too low: ${phosphorusIssue.current} (Required: ${phosphorusIssue.ideal})`,
                    solutions: currentLanguage === 'ar' ? [
                        `ğŸ’ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø³Ù…Ø§Ø¯ Ø§Ù„ÙØ³ÙÙˆØ±ÙŠ: Ø§Ø³ØªØ®Ø¯Ù… Ø³ÙˆØ¨Ø± ÙÙˆØ³ÙØ§Øª Ø£Ùˆ Ø±ÙˆÙƒ ÙÙˆØ³ÙØ§Øª`,
                        `ğŸ¦´ Ø£Ø¶Ù Ø¹Ø¸Ø§Ù… Ù…Ø·Ø­ÙˆÙ†Ø© (Bone Meal) ØºÙ†ÙŠØ© Ø¨Ø§Ù„ÙØ³ÙÙˆØ±`,
                        `ğŸ¥— Ù…ÙŠØ§Ù‡ Ø§Ù„Ø³Ù…Ùƒ Ø£Ùˆ Ø§Ù„Ø³Ù…Ø§Ø¯ Ø§Ù„Ø³Ø§Ø¦Ù„ Ø§Ù„Ø°ÙŠ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ ÙØ³ÙÙˆØ±`
                    ] : [
                        `ğŸ’ Add phosphorus fertilizer: Use superphosphate or rock phosphate`,
                        `ğŸ¦´ Add ground bone meal (Bone Meal) rich in phosphorus`,
                        `ğŸ¥— Fish emulsion or liquid fertilizers containing phosphorus`
                    ]
                });
            }

            // Potassium recommendations
            const potassiumIssue = compatibility.issues.find(i => i.type === 'potassium');
            if (potassiumIssue) {
                recommendations.push({
                    type: 'potassium',
                    title: currentLanguage === 'ar' ? 'âœ¨ Ø§Ù„Ø¨ÙˆØªØ§Ø³ÙŠÙˆÙ… (K)' : 'âœ¨ Potassium (K)',
                    issue: currentLanguage === 'ar' ? 
                        `Ø§Ù„Ø¨ÙˆØªØ§Ø³ÙŠÙˆÙ… Ù…Ù†Ø®ÙØ¶: ${potassiumIssue.current} (Ø§Ù„Ù…Ø·Ù„ÙˆØ¨: ${potassiumIssue.ideal})` :
                        `Potassium too low: ${potassiumIssue.current} (Required: ${potassiumIssue.ideal})`,
                    solutions: currentLanguage === 'ar' ? [
                        `ğŸŒ³ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¨ÙˆØªØ§Ø³ÙŠÙˆÙ…: Ø§Ø³ØªØ®Ø¯Ù… ÙƒØ¨Ø±ÙŠØªØ§Øª Ø§Ù„Ø¨ÙˆØªØ§Ø³ÙŠÙˆÙ… Ø£Ùˆ ÙƒÙ„ÙˆØ±ÙŠØ¯ Ø§Ù„Ø¨ÙˆØªØ§Ø³ÙŠÙˆÙ…`,
                        `ğŸ¥˜ Ø±Ù…Ø§Ø¯ Ø§Ù„Ø®Ø´Ø¨ (Wood Ash) Ù…ØµØ¯Ø± Ø·Ø¨ÙŠØ¹ÙŠ ØºÙ†ÙŠ Ø¨Ø§Ù„Ø¨ÙˆØªØ§Ø³ÙŠÙˆÙ…`,
                        `ğŸŒ Ø³Ù…Ø§Ø¯ Ø§Ù„Ù…ÙˆØ²: Ø§ØºÙ…Ø± Ù‚Ø´ÙˆØ± Ø§Ù„Ù…ÙˆØ² ÙÙŠ Ø§Ù„Ù…Ø§Ø¡ Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø³Ù…Ø§Ø¯ ØºÙ†ÙŠ Ø¨Ø§Ù„Ø¨ÙˆØªØ§Ø³ÙŠÙˆÙ…`
                    ] : [
                        `ğŸŒ³ Add potassium: Use potassium sulfate or potassium chloride`,
                        `ğŸ¥˜ Wood ash - natural source rich in potassium`,
                        `ğŸŒ Banana peel fertilizer: Soak banana peels in water for potassium-rich liquid`
                    ]
                });
            }

            return recommendations;
        }

        // Display comprehensive analysis results
        function displayManualAnalysisResults(compatibility, recommendations, soilData) {
            const t = translations[currentLanguage];
            const resultsScreen = document.getElementById('resultsScreen');
            const resultsList = document.getElementById('resultsList');
            
            // Get plant name based on current language
            let plantName = currentSelectedPlant.nameAr || currentSelectedPlant.nameEn || currentSelectedPlant.name || 'Ø§Ù„Ù†Ø¨Ø§Øª';
            if (currentLanguage === 'en' && currentSelectedPlant.nameEn) {
                plantName = currentSelectedPlant.nameEn;
            } else if (currentLanguage === 'fr' && currentSelectedPlant.nameFr) {
                plantName = currentSelectedPlant.nameFr;
            } else if (currentLanguage === 'es' && currentSelectedPlant.nameEs) {
                plantName = currentSelectedPlant.nameEs;
            } else if (currentLanguage === 'de' && currentSelectedPlant.nameDe) {
                plantName = currentSelectedPlant.nameDe;
            }

            let resultsHTML = `
                <div class="result-box">
                    <h4>${t.soilQuality || 'Ø¬ÙˆØ¯Ø© Ø§Ù„ØªØ±Ø¨Ø©'}</h4>
                    <div style="margin: 15px 0; text-align: center;">
                        <span style="font-size: 24px; font-weight: bold; color: #667eea;">${compatibility.soilQuality}%</span>
                        <p style="font-size: 12px; color: #999; margin-top: 5px;">
                            ${currentLanguage === 'ar' ? 'Ù…Ù†Ø§Ø³Ø¨Ø© Ù„: ' : 'Suitable for: '} <strong>${plantName}</strong>
                        </p>
                    </div>
                    <div class="quality-bar">
                        <div class="quality-fill" style="width: ${compatibility.soilQuality}%"></div>
                    </div>
                </div>
            `;

            // Compatibility status
            if (compatibility.isFullyCompatible) {
                resultsHTML += `
                    <div class="result-box" style="background: #e8f5e9; border-left-color: #4CAF50;">
                        <h4 style="color: #4CAF50;">âœ… ${currentLanguage === 'ar' ? 'Ø§Ù„ØªØ±Ø¨Ø© Ù…Ù†Ø§Ø³Ø¨Ø© ØªÙ…Ø§Ù…Ø§Ù‹!' : 'Perfect soil compatibility!'}</h4>
                        <p>${currentLanguage === 'ar' ? 'Ø¬Ù…ÙŠØ¹ Ø®ØµØ§Ø¦Øµ Ø§Ù„ØªØ±Ø¨Ø© Ù…Ù†Ø§Ø³Ø¨Ø© Ù„Ø²Ø±Ø§Ø¹Ø© Ù‡Ø°Ø§ Ø§Ù„Ù†Ø¨Ø§Øª.' : 'All soil properties are perfect for this plant.'}</p>
                    </div>
                `;
            } else {
                resultsHTML += `
                    <div class="result-box" style="background: #fff3e0; border-left-color: #ff9800;">
                        <h4 style="color: #ff9800;">âš ï¸ ${currentLanguage === 'ar' ? 'Ø§Ù„ØªØ±Ø¨Ø© ØªØ­ØªØ§Ø¬ Ø¥Ù„Ù‰ ØªØ­Ø³ÙŠÙ†' : 'Soil needs improvement'}</h4>
                        <p>${currentLanguage === 'ar' ? 'Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø´Ø§ÙƒÙ„: ' : 'Number of issues: '}<strong>${compatibility.issues.length}</strong></p>
                    </div>
                `;
            }

            // Show all recommendations from AI
            if (recommendations.length > 0) {
                resultsHTML += `<div style="margin-top: 20px;">`;
                resultsHTML += `<h4 style="color: #667eea; margin-bottom: 15px;">ğŸ¤– ${currentLanguage === 'ar' ? 'ØªÙˆØµÙŠØ§Øª AI Ø§Ù„Ù…ØªØ®ØµØµØ©' : 'AI Expert Recommendations'}</h4>`;
                
                recommendations.forEach((rec, index) => {
                    resultsHTML += `
                        <div class="result-box" style="margin-bottom: 15px;">
                            <h5 style="color: #667eea; margin-bottom: 8px;">${rec.title}</h5>
                            <p style="font-size: 12px; color: #666; margin-bottom: 10px; padding: 8px; background: #f5f5f5; border-radius: 4px;">
                                ${rec.issue}
                            </p>
                            <div style="padding-left: 10px; border-left: 3px solid #667eea;">
                                ${rec.solutions.map((sol, i) => `<p style="font-size: 13px; margin: 8px 0; color: #333;">âœ“ ${sol}</p>`).join('')}
                            </div>
                        </div>
                    `;
                });
                
                resultsHTML += `</div>`;
            }

            resultsList.innerHTML = resultsHTML;
            hideAllScreens();
            resultsScreen.classList.add('active');
        }

        // Display results for auto mode
        function displayResults(analysis) {
            const t = translations[currentLanguage];
            const resultsScreen = document.getElementById('resultsScreen');
            const resultsList = document.getElementById('resultsList');
            
            let resultsHTML = `
                <div class="result-box">
                    <h4>${t.soilQuality}</h4>
                    <div class="quality-bar">
                        <div class="quality-fill" style="width: ${analysis.soilQuality || 0}%"></div>
                    </div>
                    <div style="text-align: center; margin-top: 10px; font-weight: bold; color: #667eea;">
                        ${analysis.soilQuality || 0}%
                    </div>
                </div>
            `;

            if (analysis.suitablePlants && analysis.suitablePlants.length > 0) {
                resultsHTML += `
                    <div class="result-box">
                        <h4>${t.suitablePlants}</h4>
                        <div class="plants-grid">
                            ${analysis.suitablePlants.slice(0, 6).map(p => {
                                const displayName = p.nameAr || p.nameEn || p.name || 'Ù†Ø¨Ø§Øª';
                                return `
                                <div class="plant-card">
                                    <div class="emoji">${p.emoji || 'ğŸŒ±'}</div>
                                    <div class="plant-name-small">${displayName}</div>
                                    <div class="compatibility">${p.compatibility}% âœ“</div>
                                </div>
                            `;
                            }).join('')}
                        </div>
                    </div>
                `;
            }

            if (analysis.solutions && analysis.solutions.length > 0) {
                resultsHTML += `
                    <div class="result-box">
                        <h4>${t.solutions}</h4>
                        <ul style="padding-right: 20px;">
                            ${analysis.solutions.slice(0, 4).map(s => `<li style="margin: 8px 0;">âœ“ ${s}</li>`).join('')}
                        </ul>
                    </div>
                `;
            }

            resultsList.innerHTML = resultsHTML;
            hideAllScreens();
            resultsScreen.classList.add('active');
        }

        // Initialize system
        document.addEventListener('DOMContentLoaded', function() {
            createLanguageSelector();
            updateText();
            connectToBridge();
        });
    </script>

    <!-- WebSocket Connection for Auto Data - Enhanced -->
    <script>
        const autoDataReceiver = {
            ws: null,
            dataCount: 0,
            isConnected: false,
            reconnectAttempts: 0,
            maxReconnectAttempts: 10,
            
            connect: function() {
                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const host = window.location.hostname || 'localhost';
                const port = window.location.port || '3000';
                const wsUrl = `${protocol}//${host}:${port}`;
                
                console.log('ğŸ”— Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€:', wsUrl);
                console.log('â±ï¸ Ù…Ø­Ø§ÙˆÙ„Ø© Ø±Ù‚Ù…:', this.reconnectAttempts + 1);
                
                try {
                    this.ws = new WebSocket(wsUrl);
                    
                    this.ws.onopen = () => {
                        this.isConnected = true;
                        this.reconnectAttempts = 0;
                        console.log('âœ… Ù…ØªØµÙ„ Ø¨Ù€ Bridge Ø¨Ù†Ø¬Ø§Ø­!');
                        this.updateStatus(true, 'Ù…ØªØµÙ„');
                    };
                    
                    this.ws.onmessage = (event) => {
                        try {
                            const data = JSON.parse(event.data);
                            this.dataCount++;
                            
                            // Ø·Ø¨Ø§Ø¹Ø© ÙÙŠ Console
                            console.log(`ğŸ“Š Ø¨ÙŠØ§Ù†Ø© Ø±Ù‚Ù… ${this.dataCount}:`, data);
                            console.table({
                                'Ø¯Ø±Ø¬Ø© Ø§Ù„Ø­Ø±Ø§Ø±Ø©': `${data.TEMP}Â°C`,
                                'Ø§Ù„Ø±Ø·ÙˆØ¨Ø©': `${data.MOISTURE}%`,
                                'Ø§Ù„Ù€ pH': data.PH,
                                'Ø§Ù„Ù†ÙŠØªØ±ÙˆØ¬ÙŠÙ†': data.N,
                                'Ø§Ù„ÙØ³ÙÙˆØ±': data.P,
                                'Ø§Ù„Ø¨ÙˆØªØ§Ø³ÙŠÙˆÙ…': data.K,
                                'Ø§Ù„ÙˆÙ‚Øª': new Date().toLocaleTimeString('ar-SA')
                            });
                            
                            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø¨Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
                            this.displayData(data);
                            
                            // ØªØ­Ø¯ÙŠØ« Ø¢Ø®Ø± Ø¨ÙŠØ§Ù†Ø© ÙÙŠ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¹Ø§Ù…Ø©
                            window.lastSensorData = data;
                            
                            // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ÙˆØ¶Ø¹ ØªÙ„Ù‚Ø§Ø¦ÙŠØŒ Ø­Ø¯Ø« Ø§Ù„ØªØ­Ù„ÙŠÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
                            if (window.currentMode === 'auto' && window.analyzeManual) {
                                setTimeout(() => window.analyzeManual(), 500);
                            }
                        } catch (error) {
                            console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ÙÙƒ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', error, 'Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø®Ø§Ù…:', event.data);
                        }
                    };
                    
                    this.ws.onerror = (error) => {
                        console.error('âŒ Ø®Ø·Ø£ WebSocket:', error);
                        this.updateStatus(false, 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„');
                    };
                    
                    this.ws.onclose = () => {
                        this.isConnected = false;
                        console.warn('âš ï¸ ØªÙ… Ù‚Ø·Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„');
                        this.updateStatus(false, 'ØºÙŠØ± Ù…ØªØµÙ„');
                        
                        if (this.reconnectAttempts < this.maxReconnectAttempts) {
                            const delay = Math.min(3000 + this.reconnectAttempts * 1000, 10000);
                            console.log(`â³ Ø¥Ø¹Ø§Ø¯Ø© Ù…Ø­Ø§ÙˆÙ„Ø© ÙÙŠ ${delay}ms...`);
                            this.reconnectAttempts++;
                            setTimeout(() => this.connect(), delay);
                        } else {
                            console.error('âŒ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø¹Ø¯ Ø¹Ø¯Ø© Ù…Ø­Ø§ÙˆÙ„Ø§Øª');
                            this.updateStatus(false, 'ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„');
                        }
                    };
                } catch (error) {
                    console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ WebSocket:', error);
                    this.updateStatus(false, 'Ø®Ø·Ø£');
                }
            },
            
            displayData: function(data) {
                const fields = {
                    'tempInput': data.TEMP || data.temperature,
                    'moistureInput': data.MOISTURE || data.humidity,
                    'phInput': data.PH || data.ph,
                    'nInput': data.N || data.nitrogen,
                    'pInput': data.P || data.phosphorus,
                    'kInput': data.K || data.potassium
                };
                
                for (const [id, value] of Object.entries(fields)) {
                    const element = document.getElementById(id);
                    if (element && value !== undefined) {
                        const displayValue = typeof value === 'string' ? value : parseFloat(value).toFixed(1);
                        if (element.value !== displayValue) {
                            element.value = displayValue;
                            element.dispatchEvent(new Event('change'));
                            element.style.backgroundColor = '#e8f5e9';
                            setTimeout(() => {
                                element.style.backgroundColor = '';
                            }, 500);
                        }
                    }
                }
            },
            
            updateStatus: function(connected, message = '') {
                const statusEl = document.getElementById('bridgeStatus') || 
                                document.querySelector('[data-status="bridge"]');
                
                if (statusEl) {
                    if (connected) {
                        statusEl.textContent = 'ğŸŸ¢ ' + (message || 'Ù…ØªØµÙ„ Ø¨Ù€ Bridge');
                        statusEl.style.color = '#4CAF50';
                        statusEl.style.fontWeight = 'bold';
                    } else {
                        statusEl.textContent = 'ğŸ”´ ' + (message || 'ØºÙŠØ± Ù…ØªØµÙ„');
                        statusEl.style.color = '#f44336';
                        statusEl.style.fontWeight = 'bold';
                    }
                }
            }
        };

        // Ø§Ù„Ø§ØªØµØ§Ù„ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
        window.addEventListener('DOMContentLoaded', () => {
            console.log('ğŸ“„ ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© - Ø¨Ø¯Ø¡ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Bridge...');
            autoDataReceiver.connect();
        });
        
        // Ø¥Ø¹Ø§Ø¯Ø© Ø§ØªØµØ§Ù„ Ø¹Ù†Ø¯ Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„
        window.addEventListener('beforeunload', () => {
            if (autoDataReceiver.ws) {
                autoDataReceiver.ws.close();
            }
        });
    </script>
</body>
</html>
