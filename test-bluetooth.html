<!DOCTYPE html>
<html dir="auto" lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÙØ­Øµ Ø§ØªØµØ§Ù„ Bluetooth | Bluetooth Connection Test</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 600px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .status {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }

        .status-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }

        .status-text {
            font-size: 16px;
            font-weight: bold;
            color: #333;
        }

        .info-box {
            background: #e3f2fd;
            border-left: 4px solid #2196F3;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
        }

        .info-box strong {
            color: #1976D2;
        }

        .buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 150px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .btn-primary:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: #f44336;
            color: white;
        }

        .btn-secondary:hover {
            background: #da190b;
        }

        .data-display {
            background: #1e1e1e;
            color: #00ff00;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 20px;
            display: none;
        }

        .data-display.active {
            display: block;
        }

        .log-line {
            padding: 2px 0;
            border-bottom: 1px solid #333;
        }

        .log-line.error {
            color: #ff0000;
        }

        .log-line.warning {
            color: #ffaa00;
        }

        .log-line.success {
            color: #00ff00;
        }

        .checklist {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .checklist-item {
            display: flex;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }

        .checklist-item:last-child {
            border-bottom: none;
        }

        .checklist-icon {
            font-size: 20px;
            margin-right: 10px;
            min-width: 25px;
        }

        .checklist-text {
            flex: 1;
        }

        .speed-test {
            background: #fff3e0;
            border-left: 4px solid #ff9800;
            padding: 15px;
            margin-top: 20px;
            border-radius: 5px;
        }

        .speed-test strong {
            color: #e65100;
        }

        @media (max-width: 600px) {
            .container {
                padding: 20px;
            }

            h1 {
                font-size: 22px;
            }

            .buttons {
                flex-direction: column;
            }

            button {
                width: 100%;
            }
        }

        .badge {
            display: inline-block;
            background: #4CAF50;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            margin-left: 10px;
        }

        .badge.error {
            background: #f44336;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ”— ÙØ­Øµ Ø§ØªØµØ§Ù„ Bluetooth</h1>
    <p class="subtitle">Bluetooth Connection Test</p>

    <!-- Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ -->
    <div class="status">
        <div class="status-icon" id="statusIcon">ğŸ”´</div>
        <div class="status-text" id="statusText">ØºÙŠØ± Ù…ØªØµÙ„ | Disconnected</div>
    </div>

    <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª -->
    <div class="info-box">
        <strong>ğŸ“ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ:</strong><br>
        localhost:3000/test-bluetooth.html
    </div>

    <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙØ­ÙˆØµØ§Øª -->
    <div class="checklist">
        <strong>ğŸ“‹ Ø§Ù„ÙØ­ÙˆØµØ§Øª:</strong>
        <div class="checklist-item">
            <span class="checklist-icon" id="check1">âŒ</span>
            <span class="checklist-text">Web Serial API Ù…ØªÙˆÙØ±Ø©ØŸ</span>
            <span class="badge" id="badge1">Ù…ØªØ­Ù‚Ù‚</span>
        </div>
        <div class="checklist-item">
            <span class="checklist-icon" id="check2">âŒ</span>
            <span class="checklist-text">Bridge Ù…ØªØµÙ„ØŸ</span>
            <span class="badge" id="badge2">Ù…ØªØ­Ù‚Ù‚</span>
        </div>
        <div class="checklist-item">
            <span class="checklist-icon" id="check3">âŒ</span>
            <span class="checklist-text">WebSocket ÙŠØ¹Ù…Ù„ØŸ</span>
            <span class="badge" id="badge3">Ù…ØªØ­Ù‚Ù‚</span>
        </div>
        <div class="checklist-item">
            <span class="checklist-icon" id="check4">âŒ</span>
            <span class="checklist-text">Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø³ØªÙ‚Ø¨Ù„Ø©ØŸ</span>
            <span class="badge" id="badge4">Ù…ØªØ­Ù‚Ù‚</span>
        </div>
    </div>

    <!-- Ø§Ù„Ø£Ø²Ø±Ø§Ø± -->
    <div class="buttons">
        <button class="btn-primary" onclick="testWebSerial()">
            ğŸ”— Ø§Ø®ØªØ¨Ø± Web Serial
        </button>
        <button class="btn-primary" onclick="testBridge()">
            ğŸŒ‰ Ø§Ø®ØªØ¨Ø± Bridge
        </button>
        <button class="btn-primary" onclick="testWebSocket()">
            ğŸ“¨ Ø§Ø®ØªØ¨Ø± WebSocket
        </button>
        <button class="btn-secondary" onclick="clearLog()">
            ğŸ§¹ Ø§Ù…Ø³Ø­
        </button>
    </div>

    <!-- Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª -->
    <div class="data-display" id="dataDisplay">
        <div class="log-line success">ğŸ“Š Ø³Ø¬Ù„ Ø§Ù„ÙØ­Øµ:</div>
    </div>

    <!-- Ù†ØµØ§Ø¦Ø­ -->
    <div class="speed-test">
        <strong>ğŸ’¡ Ù†ØµØ§Ø¦Ø­:</strong>
        <ul style="margin-left: 20px; margin-top: 10px; font-size: 13px;">
            <li>Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ ÙƒÙ„ Ø²Ø± Ø¨Ø§Ù„ØªØ±ØªÙŠØ¨</li>
            <li>Ø§Ù‚Ø±Ø£ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø¨Ø¹Ù†Ø§ÙŠØ©</li>
            <li>Ø§ÙØªØ­ F12 Console Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø£ÙƒØ«Ø±</li>
            <li>ØªØ£ÙƒØ¯ Ù…Ù† ØªÙˆØµÙŠÙ„ Arduino Ù‚Ø¨Ù„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</li>
        </ul>
    </div>
</div>

<script>
    // ==================== Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª ====================
    
    let ws = null;
    let serialPort = null;
    let dataCount = 0;
    const startTime = Date.now();

    // ==================== Ø§Ù„Ø¯ÙˆØ§Ù„ ====================

    function log(message, type = 'info') {
        const display = document.getElementById('dataDisplay');
        display.classList.add('active');

        const line = document.createElement('div');
        line.className = `log-line ${type}`;

        const time = new Date().toLocaleTimeString('ar-SA');
        line.textContent = `[${time}] ${message}`;

        display.appendChild(line);
        display.scrollTop = display.scrollHeight;

        console.log(message);
    }

    function clearLog() {
        const display = document.getElementById('dataDisplay');
        display.innerHTML = '<div class="log-line success">ğŸ“Š Ø³Ø¬Ù„ Ø§Ù„ÙØ­Øµ:</div>';
        dataCount = 0;
    }

    function updateStatus(icon, text) {
        document.getElementById('statusIcon').textContent = icon;
        document.getElementById('statusText').textContent = text;
    }

    function updateCheckbox(num, passed) {
        const icon = document.getElementById(`check${num}`);
        const badge = document.getElementById(`badge${num}`);
        
        if (passed) {
            icon.textContent = 'âœ…';
            badge.className = 'badge';
            badge.textContent = 'âœ“ ØªÙ…';
        } else {
            icon.textContent = 'âŒ';
            badge.className = 'badge error';
            badge.textContent = 'âœ— ÙØ´Ù„';
        }
    }

    // ==================== Ø§Ø®ØªØ¨Ø§Ø± Web Serial ====================

    async function testWebSerial() {
        log('ğŸ§ª Ø§Ø®ØªØ¨Ø§Ø± Web Serial API...', 'info');
        
        if (!navigator.serial) {
            log('âŒ Web Serial API ØºÙŠØ± Ù…ØªÙˆÙØ±Ø©', 'error');
            log('ğŸ’¡ Ø§Ø³ØªØ®Ø¯Ù… Chrome 89+ Ø£Ùˆ Edge', 'warning');
            updateCheckbox(1, false);
            return;
        }

        try {
            const ports = await navigator.serial.getPorts();
            log(`âœ… Web Serial API Ù…ØªÙˆÙØ±Ø©`, 'success');
            log(`ğŸ“ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù†Ø§ÙØ° Ø§Ù„Ù…ØªØ§Ø­Ø©: ${ports.length}`, 'info');
            updateCheckbox(1, true);

            if (ports.length === 0) {
                log('ğŸ’¡ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†Ø§ÙØ° Ù…ØªØµÙ„Ø©', 'warning');
            } else {
                ports.forEach((port, i) => {
                    log(`   [${i}] ${port.constructor.name}`, 'info');
                });
            }
        } catch (error) {
            log(`âŒ Ø®Ø·Ø£: ${error.message}`, 'error');
            updateCheckbox(1, false);
        }
    }

    // ==================== Ø§Ø®ØªØ¨Ø§Ø± Bridge ====================

    async function testBridge() {
        log('ğŸ§ª Ø§Ø®ØªØ¨Ø§Ø± Bridge...', 'info');
        updateStatus('â³', 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ÙØ­Øµ...');

        try {
            const response = await fetch('http://localhost:3000/api/status');
            const data = await response.json();

            log(`âœ… Bridge Ù…ØªØµÙ„`, 'success');
            log(`   Ø§Ù„Ø­Ø§Ù„Ø©: ${data.status}`, 'info');
            log(`   Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø§Ù„Ù…ØªØµÙ„ÙŠÙ†: ${data.connectedClients}`, 'info');
            log(`   Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©:`, 'info');
            log(`      Ø§Ù„Ø­Ø±Ø§Ø±Ø©: ${data.currentData.temperature}Â°C`, 'info');
            log(`      Ø§Ù„Ø±Ø·ÙˆØ¨Ø©: ${data.currentData.humidity}%`, 'info');
            
            updateCheckbox(2, true);
            updateStatus('ğŸŸ¢', 'Bridge Ù…ØªØµÙ„');
        } catch (error) {
            log(`âŒ Bridge ØºÙŠØ± Ù…ØªÙˆÙØ±: ${error.message}`, 'error');
            log('ğŸ’¡ ØªØ£ÙƒØ¯ Ù…Ù† ØªØ´ØºÙŠÙ„: npm start', 'warning');
            updateCheckbox(2, false);
            updateStatus('ğŸ”´', 'Bridge ØºÙŠØ± Ù…ØªØµÙ„');
        }
    }

    // ==================== Ø§Ø®ØªØ¨Ø§Ø± WebSocket ====================

    async function testWebSocket() {
        log('ğŸ§ª Ø§Ø®ØªØ¨Ø§Ø± WebSocket...', 'info');

        return new Promise((resolve) => {
            try {
                ws = new WebSocket('ws://localhost:3000');

                ws.onopen = () => {
                    log(`âœ… WebSocket Ù…ØªØµÙ„`, 'success');
                    updateCheckbox(3, true);
                    updateStatus('ğŸŸ¢', 'WebSocket Ù…ØªØµÙ„');
                    
                    // Ø§Ø³ØªÙ‚Ø¨Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù…Ø¯Ø© 10 Ø«ÙˆØ§Ù†ÙŠ
                    const timeout = setTimeout(() => {
                        log(`â±ï¸  Ø§Ù†ØªÙ‡Øª Ù…Ø¯Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±`, 'warning');
                        if (ws) ws.close();
                        resolve();
                    }, 10000);

                    ws.onmessage = (event) => {
                        try {
                            const data = JSON.parse(event.data);
                            dataCount++;
                            log(`ğŸ“Š Ø¨ÙŠØ§Ù†Ø© Ø±Ù‚Ù… ${dataCount}: ${JSON.stringify(data).substring(0, 50)}...`, 'success');
                            updateCheckbox(4, true);
                        } catch (e) {
                            log(`âš ï¸  Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± ØµØ§Ù„Ø­Ø©: ${event.data}`, 'warning');
                        }
                    };

                    ws.onerror = (error) => {
                        log(`âŒ Ø®Ø·Ø£ WebSocket: ${error}`, 'error');
                        updateCheckbox(3, false);
                    };

                    ws.onclose = () => {
                        log(`âœ… ØªÙ… Ù‚Ø·Ø¹ Ø§ØªØµØ§Ù„ WebSocket`, 'info');
                        clearTimeout(timeout);
                        resolve();
                    };
                };

                ws.onerror = () => {
                    log(`âŒ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ WebSocket`, 'error');
                    log('ğŸ’¡ ØªØ£ÙƒØ¯ Ù…Ù† ØªØ´ØºÙŠÙ„: npm start', 'warning');
                    updateCheckbox(3, false);
                    updateStatus('ğŸ”´', 'WebSocket ØºÙŠØ± Ù…ØªØµÙ„');
                    resolve();
                };
            } catch (error) {
                log(`âŒ Ø®Ø·Ø£: ${error.message}`, 'error');
                updateCheckbox(3, false);
                resolve();
            }
        });
    }

    // ==================== Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„ ====================

    window.addEventListener('load', async () => {
        log('ğŸš€ Ø¨Ø¯Ø¡ Ø§Ù„ÙØ­ØµÙˆØµØ§Øª...', 'info');
        
        // Ø§Ø®ØªØ¨Ø± Web Serial
        await new Promise(r => {
            testWebSerial();
            setTimeout(r, 1000);
        });

        // Ø§Ø®ØªØ¨Ø± Bridge
        await new Promise(r => {
            testBridge();
            setTimeout(r, 1000);
        });

        // Ø§Ø®ØªØ¨Ø± WebSocket
        await testWebSocket();

        // Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©
        setTimeout(() => {
            const all = dataCount > 0;
            if (all) {
                log('âœ… Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙØ­ØµÙˆØµØ§Øª Ù†Ø¬Ø­Øª! Ø§Ù„Ù†Ø¸Ø§Ù… Ø¬Ø§Ù‡Ø² ğŸ‰', 'success');
                updateStatus('ğŸŸ¢', 'Ø§Ù„Ù†Ø¸Ø§Ù… Ø¬Ø§Ù‡Ø²');
            } else {
                log('âŒ Ø¨Ø¹Ø¶ Ø§Ù„ÙØ­ØµÙˆØµØ§Øª ÙØ´Ù„Øª - ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ø£Ø¹Ù„Ø§Ù‡', 'error');
                updateStatus('ğŸ”´', 'Ù‡Ù†Ø§Ùƒ Ù…Ø´Ø§ÙƒÙ„');
            }
        }, 1000);
    });
</script>

</body>
</html>
