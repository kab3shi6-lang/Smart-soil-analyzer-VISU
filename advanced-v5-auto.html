<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Soil Analyzer - Auto Readings</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        h1 {
            color: #333;
            font-size: 28px;
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: bold;
            padding: 10px 20px;
            border-radius: 25px;
            background: #f0f0f0;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .status-dot.connected {
            background: #4caf50;
            box-shadow: 0 0 10px #4caf50;
        }

        .status-dot.disconnected {
            background: #f44336;
            animation: none;
        }

        .status-dot.connecting {
            background: #ff9800;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .readings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .reading-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            transition: transform 0.3s ease;
        }

        .reading-card:hover {
            transform: translateY(-5px);
        }

        .reading-label {
            font-size: 14px;
            color: #666;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
        }

        .reading-value {
            font-size: 36px;
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }

        .reading-unit {
            font-size: 14px;
            color: #999;
        }

        .reading-status {
            font-size: 12px;
            color: #999;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #eee;
        }

        .charts-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .chart-wrapper {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .chart-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
        }

        .error-message {
            background: #ff6b6b;
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: none;
        }

        .error-message.show {
            display: block;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                transform: translateY(-20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .info-bar {
            background: rgba(33, 150, 243, 0.1);
            border-left: 4px solid #2196f3;
            padding: 15px 20px;
            border-radius: 5px;
            margin-bottom: 20px;
            color: #1976d2;
            font-size: 14px;
        }

        footer {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            color: #666;
            margin-top: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .loading {
            animation: loading 1s infinite;
        }

        @keyframes loading {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }

        .no-data {
            color: #999;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header with connection status -->
        <header>
            <div>
                <h1>üå± Smart Soil Analyzer</h1>
                <p style="color: #999; margin-top: 5px;">Real-time sensor monitoring</p>
            </div>
            <div class="connection-status">
                <div class="status-dot connecting" id="statusDot"></div>
                <span id="statusText">Connecting...</span>
            </div>
        </header>

        <!-- Error message -->
        <div class="error-message" id="errorMessage"></div>

        <!-- Info bar -->
        <div class="info-bar" id="infoBar" style="display: none;">
            ‚úì Connected to Bridge server. Updates every 5 seconds.
        </div>

        <!-- Readings Grid -->
        <div class="readings-grid">
            <div class="reading-card">
                <div class="reading-label">üå°Ô∏è Temperature</div>
                <div class="reading-value" id="tempValue" class="loading">--</div>
                <div class="reading-unit">¬∞C</div>
                <div class="reading-status" id="tempTime">Waiting for data...</div>
            </div>

            <div class="reading-card">
                <div class="reading-label">üíß Humidity</div>
                <div class="reading-value" id="humidityValue" class="loading">--</div>
                <div class="reading-unit">%</div>
                <div class="reading-status" id="humidityTime">Waiting for data...</div>
            </div>

            <div class="reading-card">
                <div class="reading-label">üåç Soil Moisture</div>
                <div class="reading-value" id="moistureValue" class="loading">--</div>
                <div class="reading-unit">%</div>
                <div class="reading-status" id="moistureTime">Waiting for data...</div>
            </div>

            <div class="reading-card">
                <div class="reading-label">‚òÄÔ∏è Light Intensity</div>
                <div class="reading-value" id="lightValue" class="loading">--</div>
                <div class="reading-unit">lux</div>
                <div class="reading-status" id="lightTime">Waiting for data...</div>
            </div>

            <div class="reading-card">
                <div class="reading-label">üß™ pH Level</div>
                <div class="reading-value" id="phValue" class="loading">--</div>
                <div class="reading-unit">pH</div>
                <div class="reading-status" id="phTime">Waiting for data...</div>
            </div>

            <div class="reading-card">
                <div class="reading-label">üìä Data Points</div>
                <div class="reading-value" id="dataCount">0</div>
                <div class="reading-unit">readings</div>
                <div class="reading-status" id="updateFreq">Update rate: 5 sec</div>
            </div>
        </div>

        <!-- Charts -->
        <div class="charts-container">
            <div class="chart-wrapper">
                <div class="chart-title">Temperature & Humidity Trend</div>
                <canvas id="tempHumidityChart"></canvas>
            </div>
            <div class="chart-wrapper">
                <div class="chart-title">Soil Moisture Trend</div>
                <canvas id="moistureChart"></canvas>
            </div>
        </div>

        <!-- Footer -->
        <footer>
            <p>Smart Soil Website ‚Ä¢ Bridge Server running on port 3000</p>
            <p style="font-size: 12px; margin-top: 10px;">Data updates automatically ‚Ä¢ Last refresh: <span id="lastUpdate">--:--:--</span></p>
        </footer>
    </div>

    <script>
        // =====================================
        // Configuration
        // =====================================
        const API_BASE = 'http://localhost:3000';
        const API_ENDPOINT = `${API_BASE}/api/readings`;
        const UPDATE_INTERVAL = 5000; // 5 seconds

        // Data storage
        let readings = [];
        const MAX_POINTS = 100;
        let isConnected = false;
        let reconnectAttempts = 0;
        const MAX_RECONNECT_ATTEMPTS = 10;

        // =====================================
        // Initialize Charts
        // =====================================
        const chartColors = {
            temp: '#e74c3c',
            humidity: '#3498db',
            moisture: '#2ecc71',
            light: '#f39c12'
        };

        let tempHumidityChart, moistureChart;

        function initializeCharts() {
            // Temperature & Humidity Chart
            const tempCtx = document.getElementById('tempHumidityChart').getContext('2d');
            tempHumidityChart = new Chart(tempCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'Temperature (¬∞C)',
                            data: [],
                            borderColor: chartColors.temp,
                            backgroundColor: 'rgba(231, 76, 60, 0.1)',
                            tension: 0.3,
                            fill: false
                        },
                        {
                            label: 'Humidity (%)',
                            data: [],
                            borderColor: chartColors.humidity,
                            backgroundColor: 'rgba(52, 152, 219, 0.1)',
                            tension: 0.3,
                            fill: false,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    interaction: { mode: 'index', intersect: false },
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: { display: true, text: 'Temperature (¬∞C)' }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: { display: true, text: 'Humidity (%)' },
                            grid: { drawOnChartArea: false }
                        }
                    }
                }
            });

            // Moisture Chart
            const moistureCtx = document.getElementById('moistureChart').getContext('2d');
            moistureChart = new Chart(moistureCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'Soil Moisture (%)',
                            data: [],
                            borderColor: chartColors.moisture,
                            backgroundColor: 'rgba(46, 204, 113, 0.1)',
                            tension: 0.3,
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            min: 0,
                            max: 100,
                            title: { display: true, text: 'Moisture (%)' }
                        }
                    }
                }
            });
        }

        // =====================================
        // Fetch readings from Bridge
        // =====================================
        async function fetchReadings() {
            try {
                const response = await fetch(API_ENDPOINT);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();
                
                if (data && typeof data === 'object') {
                    readings.push(data);
                    
                    // Keep only last MAX_POINTS
                    if (readings.length > MAX_POINTS) {
                        readings.shift();
                    }

                    updateUI(data);
                    updateCharts();
                    setConnectionStatus(true);
                    reconnectAttempts = 0;
                } else {
                    throw new Error('Invalid data format');
                }
            } catch (error) {
                console.error('Fetch error:', error);
                setConnectionStatus(false);
                showError(`Connection error: ${error.message}`);
                attemptReconnect();
            }
        }

        // =====================================
        // Update UI with latest reading
        // =====================================
        function updateUI(data) {
            const now = new Date();
            const timeStr = now.toLocaleTimeString();

            // Update temperature
            if (data.temperature !== undefined) {
                document.getElementById('tempValue').textContent = 
                    data.temperature.toFixed(1);
                document.getElementById('tempTime').textContent = `Updated: ${timeStr}`;
                document.getElementById('tempValue').classList.remove('loading');
            }

            // Update humidity
            if (data.humidity !== undefined) {
                document.getElementById('humidityValue').textContent = 
                    data.humidity.toFixed(1);
                document.getElementById('humidityTime').textContent = `Updated: ${timeStr}`;
                document.getElementById('humidityValue').classList.remove('loading');
            }

            // Update soil moisture
            if (data.soilMoisture !== undefined) {
                document.getElementById('moistureValue').textContent = 
                    data.soilMoisture.toFixed(1);
                document.getElementById('moistureTime').textContent = `Updated: ${timeStr}`;
                document.getElementById('moistureValue').classList.remove('loading');
            }

            // Update light
            if (data.light !== undefined) {
                document.getElementById('lightValue').textContent = 
                    Math.round(data.light);
                document.getElementById('lightTime').textContent = `Updated: ${timeStr}`;
                document.getElementById('lightValue').classList.remove('loading');
            }

            // Update pH
            if (data.ph !== undefined) {
                document.getElementById('phValue').textContent = 
                    data.ph.toFixed(2);
                document.getElementById('phTime').textContent = `Updated: ${timeStr}`;
                document.getElementById('phValue').classList.remove('loading');
            }

            // Update data count
            document.getElementById('dataCount').textContent = readings.length;
            document.getElementById('lastUpdate').textContent = timeStr;
        }

        // =====================================
        // Update charts
        // =====================================
        function updateCharts() {
            if (readings.length === 0) return;

            const labels = readings.map((_, i) => 
                new Date(readings[0].timestamp + i * 5000).toLocaleTimeString()
            );

            // Update temp/humidity chart
            tempHumidityChart.data.labels = labels;
            tempHumidityChart.data.datasets[0].data = readings.map(r => r.temperature);
            tempHumidityChart.data.datasets[1].data = readings.map(r => r.humidity);
            tempHumidityChart.update('none');

            // Update moisture chart
            moistureChart.data.labels = labels;
            moistureChart.data.datasets[0].data = readings.map(r => r.soilMoisture);
            moistureChart.update('none');
        }

        // =====================================
        // Connection status
        // =====================================
        function setConnectionStatus(connected) {
            isConnected = connected;
            const statusDot = document.getElementById('statusDot');
            const statusText = document.getElementById('statusText');
            const infoBar = document.getElementById('infoBar');
            const errorMessage = document.getElementById('errorMessage');

            if (connected) {
                statusDot.className = 'status-dot connected';
                statusText.textContent = 'Connected ‚úì';
                infoBar.style.display = 'block';
                errorMessage.classList.remove('show');
            } else {
                statusDot.className = 'status-dot disconnected';
                statusText.textContent = 'Disconnected';
                infoBar.style.display = 'none';
            }
        }

        // =====================================
        // Error handling
        // =====================================
        function showError(message) {
            const errorMessage = document.getElementById('errorMessage');
            errorMessage.textContent = '‚ö†Ô∏è ' + message;
            errorMessage.classList.add('show');
            
            setTimeout(() => {
                errorMessage.classList.remove('show');
            }, 5000);
        }

        // =====================================
        // Reconnect logic
        // =====================================
        function attemptReconnect() {
            if (reconnectAttempts < MAX_RECONNECT_ATTEMPTS) {
                reconnectAttempts++;
                console.log(`Reconnect attempt ${reconnectAttempts}/${MAX_RECONNECT_ATTEMPTS}`);
            } else {
                showError('Unable to connect to Bridge. Make sure npm start is running.');
            }
        }

        // =====================================
        // Initialize
        // =====================================
        function initialize() {
            console.log('üöÄ Smart Soil Website starting...');
            console.log('üì° Connecting to Bridge:', API_BASE);
            
            initializeCharts();
            setConnectionStatus(false);
            
            // Fetch immediately
            fetchReadings();
            
            // Then fetch every UPDATE_INTERVAL
            setInterval(fetchReadings, UPDATE_INTERVAL);
            
            console.log('‚úì Auto-refresh enabled every', UPDATE_INTERVAL/1000, 'seconds');
        }

        // Start when page loads
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initialize);
        } else {
            initialize();
        }
    </script>
</body>
</html>
