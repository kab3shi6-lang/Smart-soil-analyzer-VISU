<!-- 
    Ù†Ø³Ø®Ø© Ù…Ø­Ø³Ù‘Ù†Ø© Ù…Ù† advanced-v5.html
    Ù…Ø¹ Ø¯Ø¹Ù… Bluetooth Ù…Ø¨Ø§Ø´Ø± Ù…Ù† Ø§Ù„Ù…ØªØµÙØ­
    
    Ù‡Ø°Ø§ Ù…Ù„Ù ØªÙˆØ¶ÙŠØ­ÙŠ - Ø£Ø¶Ù Ø§Ù„Ø£Ø³Ø·Ø± Ø§Ù„Ù…Ù…ÙŠØ²Ø© Ø¥Ù„Ù‰ advanced-v5.html Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ
-->

<!DOCTYPE html>
<html dir="auto" lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ø­Ù„Ù„ Ø§Ù„ØªØ±Ø¨Ø© Ø§Ù„Ø°ÙƒÙŠ | Smart Soil Analyzer</title>
    
    <!-- ===== Ø§Ù„Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© ===== -->
    <style>
        /* Ø§Ù„Ù†Ù…Ø· Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ Ù…Ù† advanced-v5.html */
        /* ... (Ø§Ø­ØªÙØ¸ Ø¨ÙƒÙ„ Ø´ÙŠØ¡ ÙƒÙ…Ø§ Ù‡Ùˆ) ... */

        /* ===== Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„Ù€ Bluetooth ===== */
        
        #bluetoothPanel {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 12px 20px;
            margin: 10px;
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            animation: slideDown 0.5s ease;
        }

        @keyframes slideDown {
            from {
                transform: translateY(-20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        #bluetoothStatus {
            font-size: 14px;
            font-weight: bold;
            min-width: 80px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .bluetooth-btn {
            background: white;
            color: #667eea;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            font-size: 12px;
            transition: all 0.3s ease;
        }

        .bluetooth-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .bluetooth-btn:active {
            transform: scale(0.95);
        }

        .bluetooth-btn.connected {
            background: #4CAF50;
            color: white;
        }

        #bluetoothModal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        #bluetoothModal.active {
            display: flex;
        }

        .bluetooth-modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        .bluetooth-modal-content h2 {
            margin-top: 0;
            color: #667eea;
            text-align: center;
        }

        .port-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin: 20px 0;
            max-height: 200px;
            overflow-y: auto;
        }

        .port-item {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .port-item:hover {
            background: #f0f0f0;
            border-color: #667eea;
        }

        .port-item.selected {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .modal-buttons button {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }

        .modal-buttons .connect-btn {
            background: #4CAF50;
            color: white;
        }

        .modal-buttons .cancel-btn {
            background: #f44336;
            color: white;
        }
    </style>
</head>
<body>

<!-- ===== Ø¥Ø¶Ø§ÙØ© Ù„ÙˆØ­Ø© Bluetooth ===== -->
<div id="bluetoothPanel" style="display: none;">
    <div style="display: flex; gap: 15px; align-items: center;">
        <span>ğŸ”— Bluetooth:</span>
        <span id="bluetoothStatus">ğŸ”´ ØºÙŠØ± Ù…ØªØµÙ„</span>
    </div>
    <button class="bluetooth-btn" onclick="openBluetoothModal()">
        ğŸ”— Ø§ØªØµÙ„ Ø¨Ù€ HC-05
    </button>
</div>

<!-- ===== Ù†Ø§ÙØ°Ø© Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ù†ÙØ° ===== -->
<div id="bluetoothModal">
    <div class="bluetooth-modal-content" dir="auto">
        <h2>ğŸ”— Ø§ØªØµÙ„ Ø¨Ù€ Bluetooth</h2>
        
        <p style="text-align: center; color: #666;">
            Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†ÙØ° Ø§Ù„Ù…ØªØµÙ„ Ø¨Ù€ HC-05:
        </p>
        
        <div class="port-list" id="portList">
            <div style="text-align: center; color: #999; padding: 20px;">
                â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ù†Ø§ÙØ°...
            </div>
        </div>

        <div style="background: #f0f0f0; padding: 10px; border-radius: 5px; margin: 10px 0; font-size: 12px;">
            ğŸ’¡ <strong>Ù†ØµÙŠØ­Ø©:</strong> Ø¥Ø°Ø§ Ù„Ù… ØªØ±Ù Ø§Ù„Ù…Ù†ÙØ°:
            <ul style="margin: 5px 0; padding-left: 20px;">
                <li>ØªØ£ÙƒØ¯ Ù…Ù† ØªÙˆØµÙŠÙ„ USB</li>
                <li>Ø£Ø¹Ø¯ ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…ØªØµÙØ­</li>
                <li>Ø§Ø³ØªØ®Ø¯Ù… Chrome Ø£Ùˆ Edge</li>
            </ul>
        </div>

        <div class="modal-buttons">
            <button class="connect-btn" onclick="connectToSelectedPort()">
                Ù…ØªØµÙ„
            </button>
            <button class="cancel-btn" onclick="closeBluetoothModal()">
                Ø¥Ù„ØºØ§Ø¡
            </button>
        </div>
    </div>
</div>

<!-- ===== Ø¢Ø®Ø± Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙƒÙ…Ø§ Ù‡Ùˆ ===== -->
<!-- Ø¨Ø§Ù‚ÙŠ Ù…Ø­ØªÙˆÙ‰ advanced-v5.html Ø¨Ø¯ÙˆÙ† ØªØºÙŠÙŠØ± -->

<script>
    // ===== ÙƒÙˆØ¯ Bluetooth Ø§Ù„Ø¬Ø¯ÙŠØ¯ =====
    
    let bluetoothEnabled = false;
    let selectedPort = null;
    let serialPort = null;
    let selectedPortPath = '';

    /**
     * ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ù†ÙØ°
     */
    async function openBluetoothModal() {
        const modal = document.getElementById('bluetoothModal');
        modal.classList.add('active');
        
        // Ø£Ø­ØµÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù†Ø§ÙØ° Ø§Ù„Ù…ØªØ§Ø­Ø©
        await refreshPortList();
    }

    /**
     * Ø£ØºÙ„Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø©
     */
    function closeBluetoothModal() {
        document.getElementById('bluetoothModal').classList.remove('active');
    }

    /**
     * Ø§Ø­ØµÙ„ Ø¹Ù„Ù‰ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø§ÙØ°
     */
    async function refreshPortList() {
        const portList = document.getElementById('portList');
        
        if (!navigator.serial) {
            portList.innerHTML = `
                <div style="color: #f44336; text-align: center; padding: 20px;">
                    âŒ Web Serial API ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…Ø©<br>
                    Ø§Ø³ØªØ®Ø¯Ù… Chrome 89+ Ø£Ùˆ Edge
                </div>
            `;
            return;
        }

        try {
            const ports = await navigator.serial.getPorts();
            
            if (ports.length === 0) {
                portList.innerHTML = `
                    <div style="color: #ff9800; text-align: center; padding: 20px;">
                        âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†Ø§ÙØ° Ù…ØªØµÙ„Ø©<br>
                        ÙˆØµÙ‘Ù„ Ø¬Ù‡Ø§Ø²Ùƒ ÙˆØ£Ø¹Ø¯ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©
                    </div>
                    <button style="width: 100%; padding: 10px; margin-top: 10px;" 
                            onclick="refreshPortList()">
                        ğŸ”„ ØªØ­Ø¯ÙŠØ«
                    </button>
                `;
                return;
            }

            // Ø§Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù†Ø§ÙØ°
            portList.innerHTML = ports.map((port, index) => `
                <div class="port-item" onclick="selectPort(${index}, this)">
                    <strong>Ø§Ù„Ù…Ù†ÙØ° ${index + 1}</strong><br>
                    <small style="color: #666;">
                        ${port.getInfo().manufacturer || 'Ø¬Ù‡Ø§Ø² ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}
                    </small>
                </div>
            `).join('');
        } catch (error) {
            console.error('Ø®Ø·Ø£:', error);
            portList.innerHTML = `
                <div style="color: #f44336; text-align: center; padding: 20px;">
                    âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ù†Ø§ÙØ°
                </div>
            `;
        }
    }

    /**
     * Ø§Ø®ØªØ± Ù…Ù†ÙØ°
     */
    function selectPort(index, element) {
        // Ø£Ø²Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø³Ø§Ø¨Ù‚
        document.querySelectorAll('.port-item').forEach(item => {
            item.classList.remove('selected');
        });
        
        // Ø£Ø¶Ù Ø§Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯
        element.classList.add('selected');
        selectedPort = index;
    }

    /**
     * Ø§ØªØµÙ„ Ø¨Ø§Ù„Ù…Ù†ÙØ° Ø§Ù„Ù…Ø®ØªØ§Ø±
     */
    async function connectToSelectedPort() {
        if (selectedPort === null) {
            alert('Ø§Ø®ØªØ± Ù…Ù†ÙØ°Ø§Ù‹ Ø£ÙˆÙ„Ø§Ù‹');
            return;
        }

        try {
            const ports = await navigator.serial.getPorts();
            serialPort = ports[selectedPort];
            
            await serialPort.open({ baudRate: 9600 });
            
            console.log('âœ… ØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„');
            bluetoothEnabled = true;
            updateBluetoothUI();
            closeBluetoothModal();
            startListeningToData();
        } catch (error) {
            console.error('âŒ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„:', error);
            alert('ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„: ' + error.message);
        }
    }

    /**
     * Ø§Ø³ØªÙ…Ø¹ Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª
     */
    async function startListeningToData() {
        const reader = serialPort.readable.getReader();
        let buffer = '';

        try {
            while (true) {
                const { value, done } = await reader.read();
                if (done) break;

                const text = new TextDecoder().decode(value);
                buffer += text;

                // Ø§Ø¨Ø­Ø« Ø¹Ù† Ø£Ø³Ø·Ø± ÙƒØ§Ù…Ù„Ø©
                while (buffer.includes('\n')) {
                    const lineEnd = buffer.indexOf('\n');
                    const line = buffer.substring(0, lineEnd).trim();
                    buffer = buffer.substring(lineEnd + 1);

                    if (line) {
                        try {
                            const data = JSON.parse(line);
                            handleBluetoothData(data);
                        } catch (e) {
                            console.log('Ø¨ÙŠØ§Ù†Ø§Øª:', line);
                        }
                    }
                }
            }
        } finally {
            reader.releaseLock();
            bluetoothEnabled = false;
            updateBluetoothUI();
        }
    }

    /**
     * Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„Ø©
     */
    function handleBluetoothData(data) {
        console.log('ğŸ“Š Ø¨ÙŠØ§Ù†Ø§Øª Bluetooth:', data);
        
        // Ø­Ø¯Ù‘Ø« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©
        lastBridgeData = data;
        
        // Ø£Ø±Ø³Ù„ Ø¥Ù„Ù‰ WebSocket
        if (ws && ws.readyState === WebSocket.OPEN) {
            ws.send(JSON.stringify(data));
        }
    }

    /**
     * Ø­Ø¯Ù‘Ø« ÙˆØ§Ø¬Ù‡Ø© Bluetooth
     */
    function updateBluetoothUI() {
        const panel = document.getElementById('bluetoothPanel');
        const status = document.getElementById('bluetoothStatus');
        const btn = document.querySelector('.bluetooth-btn');
        
        panel.style.display = 'flex';
        
        if (bluetoothEnabled) {
            status.textContent = 'ğŸŸ¢ Ù…ØªØµÙ„';
            status.style.color = '#4CAF50';
            btn.textContent = 'ğŸ”Œ Ù‚Ø·Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„';
            btn.classList.add('connected');
            btn.onclick = () => disconnectBluetooth();
        } else {
            status.textContent = 'ğŸ”´ ØºÙŠØ± Ù…ØªØµÙ„';
            status.style.color = '#f44336';
            btn.textContent = 'ğŸ”— Ø§ØªØµÙ„ Ø¨Ù€ HC-05';
            btn.classList.remove('connected');
            btn.onclick = () => openBluetoothModal();
        }
    }

    /**
     * Ù‚Ø·Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„
     */
    async function disconnectBluetooth() {
        try {
            if (serialPort) {
                await serialPort.close();
            }
            bluetoothEnabled = false;
            updateBluetoothUI();
            console.log('âœ… ØªÙ… Ù‚Ø·Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„');
        } catch (error) {
            console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ù‚Ø·Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„:', error);
        }
    }

    // ØªÙ‡ÙŠØ¦Ø© Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
    document.addEventListener('DOMContentLoaded', () => {
        updateBluetoothUI();
        
        // ØªØ­Ù‚Ù‚ Ù…Ù† ØªÙˆÙØ± Web Serial API
        if (!navigator.serial) {
            console.warn('âš ï¸ Web Serial API ØºÙŠØ± Ù…ØªÙˆÙØ±Ø©');
        }
    });

    // ===== Ø§Ù†ØªÙ‡Ø§Ø¡ ÙƒÙˆØ¯ Bluetooth =====
</script>

<!-- 
    ===== ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… =====
    
    1. Ø§Ù†Ø³Ø® ÙƒÙ„ ÙƒÙˆØ¯ JavaScript Ø£Ø¹Ù„Ø§Ù‡
    2. Ø§Ù„ØµÙ‚Ù‡ ÙÙŠ advanced-v5.html Ù‚Ø¨Ù„ Ø§Ù„Ù€ </body>
    3. Ø§Ù†Ø³Ø® Ø§Ù„Ù€ CSS Ø§Ù„Ø¬Ø¯ÙŠØ¯ ÙˆØ£Ø¶ÙÙ‡ ÙÙŠ <style> Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯
    4. Ø§Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ù
    5. Ø§ÙØªØ­ ÙÙŠ Chrome Ø£Ùˆ Edge
    6. Ø§Ø¶ØºØ· Ø²Ø± "ğŸ”— Ø§ØªØµÙ„ Ø¨Ù€ HC-05"
    7. Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†ÙØ° Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
    
    ===== Ø§Ù„Ù…ØªØ·Ù„Ø¨Ø§Øª =====
    - Chrome 89+ Ø£Ùˆ Edge
    - Windows 10/11 Ø£Ùˆ macOS 11+ Ø£Ùˆ Linux
    - USB Ù…ØªØµÙ„ Ø¨Ù€ Arduino/HC-05
    
    ===== Ø§Ù„ÙÙˆØ§Ø¦Ø¯ =====
    âœ… Ø§ØªØµØ§Ù„ Ù…Ø¨Ø§Ø´Ø± Ù…Ù† Ø§Ù„Ù…ØªØµÙØ­
    âœ… Ø¨Ø¯ÙˆÙ† Node.js Ø£Ùˆ serialport
    âœ… ÙŠØ¹Ù…Ù„ ÙÙŠ Ø£ÙŠ Ù†Ø¸Ø§Ù…
    âœ… Ø§Ù„Ø®ØµÙˆØµÙŠØ© Ø¹Ø§Ù„ÙŠØ© (Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠØ©)
-->

</body>
</html>
